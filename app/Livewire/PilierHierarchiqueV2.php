<?php

namespace App\Livewire;

use Livewire\Component;
use Livewire\WithPagination;
use App\Models\Pilier;
use App\Models\ObjectifStrategique;
use App\Models\ObjectifSpecifique;
use App\Models\Action;
use App\Models\SousAction;
use App\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;

class PilierHierarchiqueV2 extends Component
{
    use WithPagination;

    // Propri√©t√©s principales
    public $pilier;
    public $currentView = 'pilier';
    public $selectedObjectifStrategique;
    public $selectedObjectifSpecifique;
    public $selectedAction;
    public $selectedSousAction;

    // √âtats des modals
    public $showCreateOSModal = false;
    public $showCreateOSPModal = false;
    public $showCreateActionModal = false;
    public $showCreateSousActionModal = false;
    public $showEditOSModal = false;
    public $showEditOSPModal = false;
    public $showEditActionModal = false;
    public $showEditSousActionModal = false;

    // Formulaires
    public $newOS = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];

    public $newOSP = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];

    public $newAction = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => '',
        'type' => 'normal'
    ];

    public $newSousAction = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => '',
        'date_echeance' => '',
        'taux_avancement' => 0,
        'type' => 'normal'
    ];

    // √âl√©ments √† √©diter
    public $editingOS;
    public $editingOSP;
    public $editingAction;
    public $editingSousAction;
    
    // Propri√©t√©s d'√©dition pour OSP
    public $editOSPCode;
    public $editOSPLibelle;
    public $editOSPDescription;
    public $editOSPOwnerId;
    
    // Variable pour l'√©dition d'objectif sp√©cifique
    public $objectifSpecifiqueToEdit;
    
    // Variables pour les sous-actions
    public $sousActionToEdit;

    // Navigation
    public $breadcrumb = [];

    protected $listeners = [
        'openPilierHierarchique' => 'openModal',
        'refreshComponent' => '$refresh'
    ];

    // M√©thode de test pour v√©rifier que le composant fonctionne
    public function testComponent()
    {
        Log::info('üß™ Test du composant PilierHierarchiqueV2', [
            'user_id' => Auth::id(),
            'pilier_id' => $this->pilier?->id,
            'current_view' => $this->currentView,
            'timestamp' => now()->toISOString()
        ]);
    }
    
    // M√©thode pour ouvrir le modal d'√©dition d'objectif sp√©cifique
    public function editObjectifSpecifique($objectifSpecifiqueId)
    {
        Log::info('üîÑ √âdition d\'objectif sp√©cifique', ['id' => $objectifSpecifiqueId]);
        
        try {
            // R√©cup√©rer l'objectif sp√©cifique
            $this->objectifSpecifiqueToEdit = ObjectifSpecifique::findOrFail($objectifSpecifiqueId);
            
            // V√©rifier les permissions
            if (!$this->canEditObjectifSpecifique($this->objectifSpecifiqueToEdit)) {
                $this->dispatch('toast', [
                    'type' => 'error',
                    'message' => 'Vous n\'avez pas les permissions pour modifier cet objectif sp√©cifique.'
                ]);
                return;
            }
            
            // Ouvrir le modal
            $this->showEditOSPModal = true;
            
            Log::info('‚úÖ Modal d\'√©dition OSP ouvert', [
                'osp_id' => $objectifSpecifiqueId,
                'osp_code' => $this->objectifSpecifiqueToEdit->code
            ]);
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de l\'ouverture du modal d\'√©dition OSP', [
                'osp_id' => $objectifSpecifiqueId,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('toast', [
                'type' => 'error',
                'message' => 'Erreur lors de l\'ouverture du formulaire d\'√©dition.'
            ]);
        }
    }

    public function mount($pilierId = null)
    {
        Log::info('üöÄ Montage du composant PilierHierarchiqueV2', [
            'pilier_id' => $pilierId,
            'user_id' => Auth::id(),
            'timestamp' => now()->toISOString()
        ]);
        
        if ($pilierId) {
            try {
                $this->pilier = Pilier::with(['owner', 'objectifsStrategiques'])->findOrFail($pilierId);
                $this->updateBreadcrumb();
                
                Log::info('‚úÖ Pilier charg√© lors du montage', [
                    'pilier_id' => $this->pilier->id,
                    'pilier_libelle' => $this->pilier->libelle
                ]);
            } catch (\Exception $e) {
                Log::error('‚ùå Erreur lors du montage', [
                    'error' => $e->getMessage(),
                    'pilier_id' => $pilierId
                ]);
            }
        } else {
            Log::info('‚ÑπÔ∏è Aucun pilier ID fourni lors du montage');
        }
    }

    public function openModal($pilierId)
    {
        try {
            Log::info('üîÑ D√©but ouverture modal V2', ['pilier_id' => $pilierId, 'user_id' => Auth::id()]);
            
            $this->pilier = Pilier::with(['owner', 'objectifsStrategiques'])->findOrFail($pilierId);
            $this->currentView = 'pilier';
            $this->resetSelections();
            $this->updateBreadcrumb();
            
            Log::info('‚úÖ Pilier charg√© avec succ√®s', [
                'pilier_id' => $this->pilier->id,
                'pilier_libelle' => $this->pilier->libelle,
                'pilier_code' => $this->pilier->code,
                'owner_id' => $this->pilier->owner_id,
                'objectifs_count' => $this->pilier->objectifsStrategiques->count()
            ]);
            
            $this->dispatch('open-modal', 'pilier-hierarchique-v2-modal');
            
            Log::info('üöÄ √âv√©nement modal envoy√©', ['modal_id' => 'pilier-hierarchique-v2-modal']);
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de l\'ouverture de la modal', [
                'error' => $e->getMessage(),
                'pilier_id' => $pilierId,
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString()
            ]);
            $this->dispatch('toast', 'error', 'Erreur lors du chargement du pilier');
        }
    }

    public function closeModal()
    {
        $this->dispatch('close-modal', 'pilier-hierarchique-v2-modal');
        $this->resetSelections();
        $this->resetForms();
    }

    // Navigation
    public function naviguerVersObjectifStrategique($objectifId)
    {
        $this->selectedObjectifStrategique = ObjectifStrategique::with(['owner', 'objectifsSpecifiques'])->findOrFail($objectifId);
        $this->currentView = 'objectifStrategique';
        $this->updateBreadcrumb();
        Log::info('Navigation vers Objectif Strat√©gique', ['os_id' => $objectifId]);
    }

    public function naviguerVersObjectifSpecifique($objectifId)
    {
        $this->selectedObjectifSpecifique = ObjectifSpecifique::with(['owner', 'actions'])->findOrFail($objectifId);
        $this->currentView = 'objectifSpecifique';
        $this->updateBreadcrumb();
        Log::info('Navigation vers Objectif Sp√©cifique', ['osp_id' => $objectifId]);
    }

    public function naviguerVersAction($actionId)
    {
        $this->selectedAction = Action::with(['owner', 'sousActions'])->findOrFail($actionId);
        $this->currentView = 'action';
        $this->updateBreadcrumb();
        Log::info('Navigation vers Action', ['action_id' => $actionId]);
    }

    public function naviguerVersSousAction($sousActionId)
    {
        $this->selectedSousAction = SousAction::with(['owner'])->findOrFail($sousActionId);
        $this->currentView = 'sousAction';
        $this->updateBreadcrumb();
        Log::info('Navigation vers Sous-Action', ['sous_action_id' => $sousActionId]);
    }

    public function retourVersPilier()
    {
        $this->currentView = 'pilier';
        $this->resetSelections();
        $this->updateBreadcrumb();
    }

    public function retourVersObjectifStrategique()
    {
        $this->currentView = 'objectifStrategique';
        $this->selectedObjectifSpecifique = null;
        $this->updateBreadcrumb();
    }

    public function retourVersObjectifSpecifique()
    {
        $this->currentView = 'objectifSpecifique';
        $this->selectedAction = null;
        $this->updateBreadcrumb();
    }

    public function retourVersAction()
    {
        $this->currentView = 'action';
        $this->selectedSousAction = null;
        $this->updateBreadcrumb();
    }

    // Gestion des formulaires
    public function openCreateOSModal()
    {
        Log::info('üöÄ Ouverture modal cr√©ation OS', [
            'user_id' => Auth::id(),
            'pilier_id' => $this->pilier?->id,
            'can_create' => $this->canCreateObjectifStrategique()
        ]);
        
        $this->showCreateOSModal = true;
        $this->resetNewOSForm();
        
        Log::info('‚úÖ Modal cr√©ation OS ouverte', ['show_create_os_modal' => $this->showCreateOSModal]);
        
        // Dispatcher l'√©v√©nement pour ouvrir la modal
        $this->dispatch('show-create-os-modal');
    }

    // M√©thodes pour l'√©dition
    public function setObjectifStrategiqueToEdit($objectifStrategiqueId)
    {
        try {
            Log::info('üîß √âdition Objectif Strat√©gique demand√©e', [
                'os_id' => $objectifStrategiqueId,
                'user_id' => Auth::id()
            ]);
            
            // R√©cup√©rer l'objet complet depuis l'ID
            $objectifStrategique = ObjectifStrategique::findOrFail($objectifStrategiqueId);
            
            Log::info('‚úÖ Objectif Strat√©gique r√©cup√©r√©', [
                'os_id' => $objectifStrategique->id,
                'os_libelle' => $objectifStrategique->libelle,
                'os_code' => $objectifStrategique->code,
                'os_description' => $objectifStrategique->description,
                'os_owner_id' => $objectifStrategique->owner_id
            ]);
            
            // Assigner l'objet complet et les propri√©t√©s d√©di√©es pour l'√©dition
            $this->editingObjectifStrategique = $objectifStrategique;
            $this->editOSCode = $objectifStrategique->code;
            $this->editOSLibelle = $objectifStrategique->libelle;
            $this->editOSDescription = $objectifStrategique->description;
            $this->editOSOwnerId = $objectifStrategique->owner_id;
            
            $this->showEditOSModal = true;
            
            Log::info('üöÄ Modal d\'√©dition OS ouverte avec donn√©es', [
                'editing_os' => $this->editingOS
            ]);
            
            // Dispatcher l'√©v√©nement pour ouvrir la modal
            $this->dispatch('show-edit-os-modal');
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de l\'ouverture de la modal d\'√©dition OS', [
                'error' => $e->getMessage(),
                'objectif_strategique_id' => $objectifStrategiqueId,
                'user_id' => Auth::id()
            ]);
            $this->dispatch('toast', 'error', 'Erreur lors du chargement de l\'objectif strat√©gique pour √©dition.');
        }
    }

    public function setObjectifSpecifiqueToEdit($objectifSpecifiqueId)
    {
        try {
            $objectifSpecifique = ObjectifSpecifique::findOrFail($objectifSpecifiqueId);
            
            Log::info('üîß √âdition Objectif Sp√©cifique', [
                'osp_id' => $objectifSpecifique->id,
                'osp_code' => $objectifSpecifique->code,
                'osp_libelle' => $objectifSpecifique->libelle,
                'osp_description' => $objectifSpecifique->description,
                'osp_owner_id' => $objectifSpecifique->owner_id,
                'user_id' => Auth::id()
            ]);
            
            // R√©initialiser les propri√©t√©s d'√©dition
            $this->editingOSP = $objectifSpecifique;
            $this->showEditOSPModal = true;
            
            // Initialiser les propri√©t√©s d'√©dition
            $this->editOSPCode = $objectifSpecifique->code;
            $this->editOSPLibelle = $objectifSpecifique->libelle;
            $this->editOSPDescription = $objectifSpecifique->description;
            $this->editOSPOwnerId = $objectifSpecifique->owner_id;
            
            // Debug : v√©rifier que les propri√©t√©s sont bien d√©finies
            Log::info('üîç Propri√©t√©s d\'√©dition d√©finies', [
                'editingOSP_id' => $this->editingOSP->id ?? 'null',
                'editOSPCode' => $this->editOSPCode ?? 'null',
                'editOSPLibelle' => $this->editOSPLibelle ?? 'null',
                'editOSPDescription' => $this->editOSPDescription ?? 'null',
                'editOSPOwnerId' => $this->editOSPOwnerId ?? 'null',
                'showEditOSPModal' => $this->showEditOSPModal
            ]);
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de l\'ouverture de la modal d\'√©dition OSP', [
                'error' => $e->getMessage(),
                'objectif_specifique_id' => $objectifSpecifiqueId
            ]);
            $this->dispatch('toast', 'error', 'Erreur lors du chargement de l\'objectif sp√©cifique pour √©dition.');
        }
    }

    public function setActionToEdit($actionId)
    {
        try {
            Log::info('üîß Ouverture du modal d\'√©dition d\'action', ['action_id' => $actionId]);
            
            $action = Action::findOrFail($actionId);
            
            Log::info('üîç Action trouv√©e:', [
                'action_id' => $action->id,
                'action_code' => $action->code,
                'action_libelle' => $action->libelle,
                'action_description' => $action->description,
                'action_owner_id' => $action->owner_id,
                'user_id' => Auth::id()
            ]);
            
            // V√©rifier que l'action est bien un objet Eloquent
            Log::info('üîç Type de l\'action:', [
                'type' => get_class($action),
                'is_object' => is_object($action),
                'has_attributes' => method_exists($action, 'getAttributes')
            ]);
            
            // Assigner l'action et les propri√©t√©s d√©di√©es
            $this->editingAction = $action;
            $this->editActionCode = $action->code;
            $this->editActionLibelle = $action->libelle;
            $this->editActionDescription = $action->description;
            $this->editActionOwnerId = $action->owner_id;
            
            $this->showEditActionModal = true;
            
            Log::info('‚úÖ Modal d\'√©dition d\'action ouvert:', [
                'editingAction_id' => $this->editingAction ? $this->editingAction->id : 'null',
                'editActionCode' => $this->editActionCode,
                'editActionLibelle' => $this->editActionLibelle,
                'editActionDescription' => $this->editActionDescription,
                'editActionOwnerId' => $this->editActionOwnerId,
                'showEditActionModal' => $this->showEditActionModal
            ]);
            
            // V√©rifier que la propri√©t√© est bien assign√©e
            Log::info('üîç V√©rification de la propri√©t√© editingAction:', [
                'propriete_existe' => property_exists($this, 'editingAction'),
                'valeur_assignee' => $this->editingAction ? 'OUI' : 'NON',
                'type_valeur' => $this->editingAction ? get_class($this->editingAction) : 'null'
            ]);
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de l\'ouverture de la modal d\'√©dition Action', [
                'error' => $e->getMessage(),
                'action_id' => $actionId
            ]);
            $this->dispatch('toast', 'error', 'Erreur lors du chargement de l\'action pour √©dition.');
        }
    }

    public function setSousActionToEdit($sousActionId)
    {
        try {
            $sousAction = SousAction::findOrFail($sousActionId);
            
            Log::info('üîß √âdition Sous-Action', [
                'sous_action_id' => $sousAction->id,
                'sous_action_libelle' => $sousAction->libelle,
                'user_id' => Auth::id()
            ]);
            
            // Assigner les valeurs aux propri√©t√©s d√©di√©es pour le binding
            $this->editingSousAction = $sousAction;
            $this->editSousActionCode = $sousAction->code;
            $this->editSousActionLibelle = $sousAction->libelle;
            $this->editSousActionDescription = $sousAction->description;
            $this->editSousActionOwnerId = $sousAction->owner_id;
            $this->showEditSousActionModal = true;
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de l\'ouverture de la modal d\'√©dition Sous-Action', [
                'error' => $e->getMessage(),
                'sous_action_id' => $sousActionId
            ]);
            $this->dispatch('toast', 'error', 'Erreur lors du chargement de la sous-action pour √©dition.');
        }
    }

    public function closeCreateOSModal()
    {
        $this->showCreateOSModal = false;
        $this->resetNewOSForm();
        $this->dispatch('hide-create-os-modal');
    }

    public function closeEditOSModal()
    {
        $this->showEditOSModal = false;
        $this->editingOS = null;
        $this->dispatch('hide-edit-os-modal');
    }

    public function closeEditOSPModal()
    {
        $this->showEditOSPModal = false;
        $this->editingOSP = null;
        
        // R√©initialiser les propri√©t√©s d'√©dition
        $this->editOSPCode = '';
        $this->editOSPLibelle = '';
        $this->editOSPDescription = '';
        $this->editOSPOwnerId = '';
        
        $this->dispatch('hide-edit-osp-modal');
    }

    public function updateObjectifSpecifique()
    {
        if (!$this->editingOSP) {
            $this->dispatch('toast', 'error', 'Aucun objectif sp√©cifique √† modifier');
            return;
        }

        if (!$this->canEditObjectifSpecifique($this->editingOSP)) {
            $this->dispatch('toast', 'error', 'Permission refus√©e');
            return;
        }

        $this->validate([
            'editOSPCode' => 'required|string|max:10',
            'editOSPLibelle' => 'required|string|max:255',
            'editOSPDescription' => 'nullable|string',
            'editOSPOwnerId' => 'required|exists:users,id'
        ]);

        try {
            // V√©rifier que l'utilisateur propri√©taire existe
            $owner = \DB::table('users')->where('id', $this->editOSPOwnerId)->first();
            if (!$owner) {
                Log::error('‚ùå Utilisateur propri√©taire non trouv√©', ['owner_id' => $this->editOSPOwnerId]);
                $this->dispatch('toast', 'error', 'Utilisateur propri√©taire non trouv√©');
                return;
            }

            // Sauvegarder l'ancien propri√©taire pour la notification
            $oldOwnerId = $this->editingOSP->owner_id;
            $newOwnerId = $this->editOSPOwnerId;

            // Mettre √† jour l'objectif sp√©cifique avec DB Query Builder
            $updated = \DB::table('objectif_specifiques')
                ->where('id', $this->editingOSP->id)
                ->update([
                    'code' => $this->editOSPCode,
                    'libelle' => $this->editOSPLibelle,
                    'description' => $this->editOSPDescription,
                    'owner_id' => $this->editOSPOwnerId,
                    'updated_at' => now()
                ]);

            if (!$updated) {
                Log::error('‚ùå √âchec de la mise √† jour de l\'objectif sp√©cifique', ['osp_id' => $this->editingOSP->id]);
                $this->dispatch('toast', 'error', 'Erreur lors de la mise √† jour');
                return;
            }

            // Mettre √† jour l'objet local pour la suite
            $this->editingOSP->code = $this->editOSPCode;
            $this->editingOSP->libelle = $this->editOSPLibelle;
            $this->editingOSP->description = $this->editOSPDescription;
            $this->editingOSP->owner_id = $this->editOSPOwnerId;

            // Envoyer notification au nouveau propri√©taire s'il est diff√©rent
            if ($oldOwnerId != $newOwnerId) {
                Log::info('üìß Envoi notification changement propri√©taire OSP', [
                    'old_owner_id' => $oldOwnerId,
                    'new_owner_id' => $newOwnerId,
                    'osp_id' => $this->editingOSP->id,
                    'osp_libelle' => $this->editingOSP->libelle
                ]);

                $notificationSent = $this->sendNotification(
                    $newOwnerId,
                    'objectif_specifique_assigned',
                    'Objectif Sp√©cifique assign√©',
                    "Vous avez √©t√© assign√© comme propri√©taire de l'objectif sp√©cifique : {$this->editingOSP->libelle}",
                    ['objectif_id' => $this->editingOSP->id, 'os_id' => $this->selectedObjectifStrategique->id]
                );

                if ($notificationSent) {
                    Log::info('‚úÖ Notification changement propri√©taire OSP envoy√©e avec succ√®s');
                } else {
                    Log::warning('‚ö†Ô∏è √âchec de l\'envoi de la notification changement propri√©taire OSP');
                }
            }

            // Mettre √† jour le taux d'avancement de l'objectif strat√©gique parent avec DB
            $this->updateOSPProgressWithDB($this->selectedObjectifStrategique->id);

            $this->closeEditOSPModal();
            $this->dispatch('toast', 'success', 'Objectif Sp√©cifique modifi√© avec succ√®s');
            $this->dispatch('refreshComponent');

            Log::info('‚úÖ Objectif Sp√©cifique mis √† jour avec succ√®s', [
                'osp_id' => $this->editingOSP->id,
                'new_code' => $this->editOSPCode,
                'new_libelle' => $this->editOSPLibelle
            ]);

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur mise √† jour Objectif Sp√©cifique', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            $this->dispatch('toast', 'error', 'Erreur lors de la modification de l\'objectif sp√©cifique');
        }
    }

    public function updateObjectifStrategique()
    {
        if (!$this->editingOS) {
            $this->dispatch('toast', 'error', 'Aucun objectif √† modifier');
            return;
        }

        $this->validate([
            'editingOS.code' => 'required|string|max:10',
            'editingOS.libelle' => 'required|string|max:255',
            'editingOS.description' => 'nullable|string',
            'editingOS.owner_id' => 'required|exists:users,id'
        ]);

        try {
            // R√©cup√©rer l'objet depuis la base de donn√©es et le mettre √† jour
            $objectifStrategique = ObjectifStrategique::findOrFail($this->editingOS['id']);
            $objectifStrategique->code = $this->editingOS['code'];
            $objectifStrategique->libelle = $this->editingOS['libelle'];
            $objectifStrategique->description = $this->editingOS['description'];
            $objectifStrategique->owner_id = $this->editingOS['owner_id'];
            $objectifStrategique->save();
            
            $this->pilier->updateTauxAvancement();
            $this->closeEditOSModal();
            $this->dispatch('toast', 'success', 'Objectif Strat√©gique mis √† jour avec succ√®s');
            $this->dispatch('refreshComponent');
            
            Log::info('‚úÖ Objectif Strat√©gique mis √† jour', [
                'os_id' => $this->editingOS['id'],
                'user_id' => Auth::id(),
                'new_data' => $this->editingOS
            ]);

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur mise √† jour Objectif Strat√©gique', ['error' => $e->getMessage()]);
            $this->dispatch('toast', 'error', 'Erreur lors de la mise √† jour');
        }
    }

    public function openCreateOSPModal()
    {
        $this->showCreateOSPModal = true;
        $this->resetNewOSPForm();
    }

    public function closeCreateOSPModal()
    {
        $this->showCreateOSPModal = false;
        $this->resetNewOSPForm();
    }

    public function openCreateActionModal()
    {
        Log::info('üîÑ Ouverture du modal de cr√©ation d\'action');
        Log::info('üîç √âtat avant ouverture:', [
            'showCreateActionModal' => $this->showCreateActionModal,
            'user_id' => Auth::id(),
            'can_create' => $this->canCreateAction(),
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null'
        ]);
        
        $this->showCreateActionModal = true;
        $this->resetNewActionForm();
        
        Log::info('‚úÖ √âtat apr√®s ouverture:', [
            'showCreateActionModal' => $this->showCreateActionModal
        ]);
    }

    public function closeCreateActionModal()
    {
        $this->showCreateActionModal = false;
        $this->resetNewActionForm();
    }

    public function closeEditActionModal()
    {
        $this->showEditActionModal = false;
        $this->editingAction = null;
    }

    public function openCreateSousActionModal()
    {
        Log::info('üîÑ Ouverture du modal de cr√©ation de sous-action');
        $this->resetNewSousAction();
        $this->showCreateSousActionModal = true;
    }
    
    public function closeCreateSousActionModal()
    {
        Log::info('üîÑ Fermeture du modal de cr√©ation de sous-action');
        $this->showCreateSousActionModal = false;
        $this->resetNewSousAction();
    }
    
    public function openEditSousActionModal($sousActionId)
    {
        Log::info('üîÑ Ouverture du modal d\'√©dition de sous-action', ['id' => $sousActionId]);
        
        try {
            $this->editingSousAction = SousAction::findOrFail($sousActionId);
            
            // V√©rifier les permissions
            if (!$this->canEditSousAction($this->editingSousAction)) {
                $this->dispatch('toast', [
                    'type' => 'error',
                    'message' => 'Vous n\'avez pas les permissions pour modifier cette sous-action.'
                ]);
                return;
            }
            
            // Assigner les valeurs aux propri√©t√©s d'√©dition
            $this->editSousActionCode = $this->editingSousAction->code;
            $this->editSousActionLibelle = $this->editingSousAction->libelle;
            $this->editSousActionDescription = $this->editingSousAction->description;
            $this->editSousActionOwnerId = $this->editingSousAction->owner_id;
            $this->editSousActionType = $this->editingSousAction->type ?? 'normal';
            $this->editSousActionDateEcheance = $this->editingSousAction->date_echeance ? $this->editingSousAction->date_echeance->format('Y-m-d') : '';
            $this->editSousActionTauxAvancement = $this->editingSousAction->taux_avancement ?? 0;
            
            $this->showEditSousActionModal = true;
            
            Log::info('‚úÖ Modal d\'√©dition de sous-action ouvert', [
                'sous_action_id' => $sousActionId,
                'sous_action_code' => $this->editingSousAction->code,
                'edit_properties_set' => true
            ]);
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de l\'ouverture du modal d\'√©dition de sous-action', [
                'sous_action_id' => $sousActionId,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('toast', [
                'type' => 'error',
                'message' => 'Erreur lors de l\'ouverture du formulaire d\'√©dition.'
            ]);
        }
    }
    
    public function closeEditSousActionModal()
    {
        Log::info('üîÑ Fermeture du modal d\'√©dition de sous-action');
        $this->showEditSousActionModal = false;
        $this->editingSousAction = null;
        
        // R√©initialiser les propri√©t√©s d'√©dition
        $this->editSousActionCode = '';
        $this->editSousActionLibelle = '';
        $this->editSousActionDescription = '';
        $this->editSousActionOwnerId = '';
        $this->editSousActionType = 'normal';
        $this->editSousActionDateEcheance = '';
        $this->editSousActionTauxAvancement = 0;
    }
    
    public function createSousAction()
    {
        Log::info('üíæ Cr√©ation d\'une nouvelle sous-action', [
            'code' => $this->newSousAction['code'],
            'libelle' => $this->newSousAction['libelle']
        ]);
        
        try {
            // Validation
            $this->validate([
                'newSousAction.code' => 'required|string|max:10',
                'newSousAction.libelle' => 'required|string|max:255',
                'newSousAction.owner_id' => 'required|exists:users,id',
                'newSousAction.date_echeance' => 'nullable|date|after_or_equal:today',
                'newSousAction.type' => 'required|in:normal,projet'
            ]);
            
            // Cr√©er la sous-action avec DB Query Builder
            $sousActionId = DB::table('sous_actions')->insertGetId([
                'code' => $this->newSousAction['code'],
                'libelle' => $this->newSousAction['libelle'],
                'description' => $this->newSousAction['description'],
                'owner_id' => $this->newSousAction['owner_id'],
                'action_id' => $this->selectedAction->id,
                'type' => $this->newSousAction['type'],
                'taux_avancement' => 0, // Taux initial √† 0%
                'date_echeance' => $this->newSousAction['date_echeance'] ?: null,
                'created_at' => now(),
                'updated_at' => now()
            ]);
            
            // Fermer le modal
            $this->closeCreateSousActionModal();
            
            // Rafra√Æchir les donn√©es de l'action s√©lectionn√©e
            $this->selectedAction = Action::with(['owner', 'sousActions'])->findOrFail($this->selectedAction->id);
            
            // Mettre √† jour le taux d'avancement de l'action parent
            $this->updateActionProgressWithDB($this->selectedAction->id);
            
            // Notification de succ√®s
            $this->dispatch('toast', [
                'type' => 'success',
                'message' => 'Sous-action cr√©√©e avec succ√®s !'
            ]);
            
            // Rafra√Æchir le composant pour afficher la nouvelle sous-action
            $this->dispatch('refreshComponent');
            
            Log::info('‚úÖ Sous-action cr√©√©e et donn√©es rafra√Æchies', [
                'sous_action_id' => $sousActionId,
                'code' => $this->newSousAction['code'],
                'action_id' => $this->selectedAction->id,
                'sous_actions_count' => $this->selectedAction->sousActions->count()
            ]);
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de la cr√©ation de la sous-action', [
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('toast', [
                'type' => 'error',
                'message' => 'Erreur lors de la cr√©ation : ' . $e->getMessage()
            ]);
        }
    }
    
    public function updateSousAction()
    {
        Log::info('üöÄ M√âTHODE updateSousAction APPEL√âE !', [
            'sous_action_id' => $this->editingSousAction?->id,
            'editSousActionCode' => $this->editSousActionCode,
            'editSousActionLibelle' => $this->editSousActionLibelle,
            'editSousActionOwnerId' => $this->editSousActionOwnerId,
            'editSousActionDateEcheance' => $this->editSousActionDateEcheance
        ]);
        
        try {
            // Validation avec les propri√©t√©s d√©di√©es
            $this->validate([
                'editSousActionCode' => 'required|string|max:10',
                'editSousActionLibelle' => 'required|string|max:255',
                'editSousActionOwnerId' => 'required|exists:users,id',
                'editSousActionDateEcheance' => 'nullable|date',
                'editSousActionType' => 'required|in:normal,projet'
            ]);
            
            // V√©rifier les permissions
            if (!$this->editingSousAction) {
                $this->dispatch('toast', 'error', 'Aucune sous-action √† modifier');
                return;
            }
            
            if (!$this->canEditSousAction($this->editingSousAction)) {
                $this->dispatch('toast', [
                    'type' => 'error',
                    'message' => 'Vous n\'avez pas les permissions pour modifier cette sous-action.'
                ]);
                return;
            }
            
            // Sauvegarder les modifications avec DB Query Builder
            $updated = DB::table('sous_actions')
                ->where('id', $this->editingSousAction->id)
                ->update([
                    'code' => $this->editSousActionCode,
                    'libelle' => $this->editSousActionLibelle,
                    'description' => $this->editSousActionDescription,
                    'owner_id' => $this->editSousActionOwnerId,
                    'type' => $this->editSousActionType,
                    'date_echeance' => $this->editSousActionDateEcheance ?: null,
                    'updated_at' => now()
                ]);
            
            if (!$updated) {
                Log::error('‚ùå √âchec de la mise √† jour de la sous-action', ['sous_action_id' => $this->editingSousAction->id]);
                $this->dispatch('toast', 'error', 'Erreur lors de la mise √† jour');
                return;
            }
            
            // Fermer le modal
            $this->closeEditSousActionModal();
            
            // Rafra√Æchir les donn√©es de l'action s√©lectionn√©e
            $this->selectedAction = Action::with(['owner', 'sousActions'])->findOrFail($this->selectedAction->id);
            
            // Mettre √† jour le taux d'avancement de l'action parent
            $this->updateActionProgressWithDB($this->selectedAction->id);
            
            // Notification de succ√®s
            $this->dispatch('toast', [
                'type' => 'success',
                'message' => 'Sous-action mise √† jour avec succ√®s !'
            ]);
            
            // Rafra√Æchir le composant pour afficher les modifications
            $this->dispatch('refreshComponent');
            
            Log::info('‚úÖ Sous-action mise √† jour et donn√©es rafra√Æchies', [
                'sous_action_id' => $this->editingSousAction->id,
                'action_id' => $this->selectedAction->id,
                'sous_actions_count' => $this->selectedAction->sousActions->count()
            ]);
            
        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de la mise √† jour de la sous-action', [
                'sous_action_id' => $this->editingSousAction?->id,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('toast', [
                'type' => 'error',
                'message' => 'Erreur lors de la mise √† jour : ' . $e->getMessage()
            ]);
        }
    }
    
    private function resetNewSousAction()
    {
        $this->newSousAction = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => '',
            'date_echeance' => '',
            'taux_avancement' => 0,
            'type' => 'normal'
        ];
    }

    // Cr√©ation
    public function createObjectifStrategique()
    {
        if (!$this->canCreateObjectifStrategique()) {
            $this->dispatch('toast', 'error', 'Permission refus√©e');
            return;
        }

        $this->validate([
            'newOS.code' => 'required|string|max:10',
            'newOS.libelle' => 'required|string|max:255',
            'newOS.description' => 'nullable|string',
            'newOS.owner_id' => 'required|exists:users,id'
        ]);

        try {
            // V√©rifier que l'utilisateur propri√©taire existe
            $owner = User::find($this->newOS['owner_id']);
            if (!$owner) {
                Log::error('‚ùå Utilisateur propri√©taire non trouv√©', ['owner_id' => $this->newOS['owner_id']]);
                $this->dispatch('toast', 'error', 'Utilisateur propri√©taire non trouv√©');
                return;
            }
            
            Log::info('üë§ Propri√©taire trouv√©', [
                'owner_id' => $owner->id,
                'owner_name' => $owner->name,
                'owner_email' => $owner->email
            ]);
            
            $objectifStrategique = new ObjectifStrategique();
            $objectifStrategique->pilier_id = $this->pilier->id;
            $objectifStrategique->code = $this->newOS['code'];
            $objectifStrategique->libelle = $this->newOS['libelle'];
            $objectifStrategique->description = $this->newOS['description'];
            $objectifStrategique->owner_id = $this->newOS['owner_id'];
            $objectifStrategique->taux_avancement = 0; // Valeur par d√©faut, calcul√©e automatiquement
            $objectifStrategique->save();

            // Envoyer notification au propri√©taire
            Log::info('üìß Envoi notification au propri√©taire', [
                'owner_id' => $this->newOS['owner_id'],
                'os_id' => $objectifStrategique->id,
                'os_libelle' => $objectifStrategique->libelle,
                'pilier_id' => $this->pilier->id
            ]);
            
            $notificationSent = $this->sendNotification(
                $this->newOS['owner_id'],
                'objectif_strategique_assigned',
                'Nouvel Objectif Strat√©gique assign√©',
                "Vous avez √©t√© assign√© comme propri√©taire de l'objectif strat√©gique : {$objectifStrategique->libelle}",
                ['objectif_id' => $objectifStrategique->id, 'pilier_id' => $this->pilier->id]
            );
            
            if ($notificationSent) {
                Log::info('‚úÖ Notification envoy√©e avec succ√®s au propri√©taire', [
                    'owner_id' => $this->newOS['owner_id'],
                    'os_id' => $objectifStrategique->id
                ]);
            } else {
                Log::warning('‚ö†Ô∏è √âchec de l\'envoi de la notification', [
                    'owner_id' => $this->newOS['owner_id'],
                    'os_id' => $objectifStrategique->id
                ]);
            }

            $this->pilier->updateTauxAvancement();
            $this->closeCreateOSModal();
            $this->dispatch('toast', 'success', 'Objectif Strat√©gique cr√©√© avec succ√®s');
            $this->dispatch('refreshComponent');

        } catch (\Exception $e) {
            Log::error('Erreur cr√©ation Objectif Strat√©gique', ['error' => $e->getMessage()]);
            $this->dispatch('toast', 'error', 'Erreur lors de la cr√©ation');
        }
    }

    public function createObjectifSpecifique()
    {
        if (!$this->canCreateObjectifSpecifique()) {
            $this->dispatch('toast', 'error', 'Permission refus√©e');
            return;
        }

        $this->validate([
            'newOSP.code' => 'required|string|max:10',
            'newOSP.libelle' => 'required|string|max:255',
            'newOSP.description' => 'nullable|string',
            'newOSP.owner_id' => 'required|exists:users,id'
        ]);

        try {
            // V√©rifier que l'utilisateur propri√©taire existe
            $owner = User::find($this->newOSP['owner_id']);
            if (!$owner) {
                Log::error('‚ùå Utilisateur propri√©taire non trouv√©', ['owner_id' => $this->newOSP['owner_id']]);
                $this->dispatch('toast', 'error', 'Utilisateur propri√©taire non trouv√©');
                return;
            }
            
            Log::info('üë§ Propri√©taire OSP trouv√©', [
                'owner_id' => $owner->id,
                'owner_name' => $owner->name,
                'owner_email' => $owner->email
            ]);
            
            $objectifSpecifique = new ObjectifSpecifique();
            $objectifSpecifique->objectif_strategique_id = $this->selectedObjectifStrategique->id;
            $objectifSpecifique->code = $this->newOSP['code'];
            $objectifSpecifique->libelle = $this->newOSP['libelle'];
            $objectifSpecifique->description = $this->newOSP['description'];
            $objectifSpecifique->owner_id = $this->newOSP['owner_id'];
            $objectifSpecifique->save();

            // Envoyer notification au propri√©taire
            Log::info('üìß Envoi notification OSP au propri√©taire', [
                'owner_id' => $this->newOSP['owner_id'],
                'osp_id' => $objectifSpecifique->id,
                'osp_libelle' => $objectifSpecifique->libelle,
                'os_id' => $this->selectedObjectifStrategique->id
            ]);
            
            $notificationSent = $this->sendNotification(
                $this->newOSP['owner_id'],
                'objectif_specifique_assigned',
                'Nouvel Objectif Sp√©cifique assign√©',
                "Vous avez √©t√© assign√© comme propri√©taire de l'objectif sp√©cifique : {$objectifSpecifique->libelle}",
                ['objectif_id' => $objectifSpecifique->id, 'os_id' => $this->selectedObjectifStrategique->id]
            );
            
            if ($notificationSent) {
                Log::info('‚úÖ Notification OSP envoy√©e avec succ√®s au propri√©taire', [
                    'owner_id' => $this->newOSP['owner_id'],
                    'osp_id' => $objectifSpecifique->id
                ]);
            } else {
                Log::warning('‚ö†Ô∏è √âchec de l\'envoi de la notification OSP', [
                    'owner_id' => $this->newOSP['owner_id'],
                    'osp_id' => $objectifSpecifique->id
                ]);
            }

            $this->selectedObjectifStrategique->updateTauxAvancement();
            $this->closeCreateOSPModal();
            $this->dispatch('toast', 'success', 'Objectif Sp√©cifique cr√©√© avec succ√®s');
            $this->dispatch('refreshComponent');

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur cr√©ation Objectif Sp√©cifique', ['error' => $e->getMessage()]);
            $this->dispatch('toast', 'error', 'Erreur lors de la cr√©ation de l\'objectif sp√©cifique');
        }
    }

    public function createAction()
    {
        Log::info('üíæ Tentative de cr√©ation d\'action');
        Log::info('üîç √âtat avant cr√©ation:', [
            'user_id' => Auth::id(),
            'user_name' => Auth::user()->name,
            'can_create' => $this->canCreateAction(),
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedObjectifStrategique' => $this->selectedObjectifStrategique ? $this->selectedObjectifStrategique->id : 'null',
            'newAction_data' => $this->newAction
        ]);
        
        if (!$this->canCreateAction()) {
            Log::warning('üö´ Permission refus√©e pour cr√©er une action', [
                'user_id' => Auth::id(),
                'user_name' => Auth::user()->name
            ]);
            $this->dispatch('toast', 'error', 'Permission refus√©e');
            return;
        }

        $this->validate([
            'newAction.code' => 'required|string|max:10',
            'newAction.libelle' => 'required|string|max:255',
            'newAction.description' => 'nullable|string',
            'newAction.owner_id' => 'required|exists:users,id'
        ]);

        try {
            // Cr√©er l'action avec DB Query Builder
            $actionId = DB::table('actions')->insertGetId([
                'objectif_specifique_id' => $this->selectedObjectifSpecifique->id,
                'code' => $this->newAction['code'],
                'libelle' => $this->newAction['libelle'],
                'description' => $this->newAction['description'],
                'owner_id' => $this->newAction['owner_id'],
                'taux_avancement' => 0, // Taux initial √† 0%
                'created_at' => now(),
                'updated_at' => now()
            ]);

            // Envoyer notification au propri√©taire
            $this->sendNotification(
                $this->newAction['owner_id'],
                'action_assigned',
                'Nouvelle Action assign√©e',
                "Vous avez √©t√© assign√© comme propri√©taire de l'action : {$this->newAction['libelle']}",
                ['action_id' => $actionId, 'osp_id' => $this->selectedObjectifSpecifique->id]
            );

            // Mettre √† jour le taux d'avancement de l'objectif sp√©cifique parent avec DB
            $this->updateOSPProgressWithDB($this->selectedObjectifSpecifique->id);
            $this->closeCreateActionModal();
            $this->dispatch('toast', 'success', 'Action cr√©√©e avec succ√®s');
            $this->dispatch('refreshComponent');

        } catch (\Exception $e) {
            Log::error('Erreur cr√©ation Action', ['error' => $e->getMessage()]);
            $this->dispatch('toast', 'error', 'Erreur lors de la cr√©ation');
        }
    }

    // M√©thodes de suppression
    public function deleteObjectifStrategique($objectifStrategiqueId)
    {
        try {
            Log::info('üóëÔ∏è Demande de suppression Objectif Strat√©gique', [
                'os_id' => $objectifStrategiqueId,
                'user_id' => Auth::id()
            ]);

            $objectifStrategique = ObjectifStrategique::findOrFail($objectifStrategiqueId);

            if (!$this->canDeleteObjectifStrategique($objectifStrategique)) {
                Log::warning('üö´ Permission refus√©e pour supprimer OS', ['user_id' => Auth::id(), 'os_id' => $objectifStrategiqueId]);
                $this->dispatch('toast', 'error', 'Permission refus√©e ou objectif li√©');
                return;
            }

            $objectifStrategique->delete();
            $this->pilier->updateTauxAvancement();
            $this->dispatch('toast', 'success', 'Objectif Strat√©gique supprim√© avec succ√®s');
            $this->dispatch('refreshComponent');
            Log::info('‚úÖ Objectif Strat√©gique supprim√©', ['os_id' => $objectifStrategiqueId]);

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur suppression Objectif Strat√©gique', ['error' => $e->getMessage(), 'os_id' => $objectifStrategiqueId]);
            $this->dispatch('toast', 'error', 'Erreur lors de la suppression');
        }
    }

    public function deleteObjectifSpecifique($objectifSpecifiqueId)
    {
        try {
            Log::info('üóëÔ∏è Demande de suppression Objectif Sp√©cifique', [
                'osp_id' => $objectifSpecifiqueId,
                'user_id' => Auth::id()
            ]);

            $objectifSpecifique = ObjectifSpecifique::findOrFail($objectifSpecifiqueId);

            if (!$this->canDeleteObjectifSpecifique($objectifSpecifique)) {
                Log::warning('üö´ Permission refus√©e pour supprimer OSP', ['user_id' => Auth::id(), 'osp_id' => $objectifSpecifiqueId]);
                $this->dispatch('toast', 'error', 'Permission refus√©e ou objectif li√©');
                return;
            }

            $objectifSpecifique->delete();
            $this->selectedObjectifStrategique->updateTauxAvancement();
            $this->dispatch('toast', 'success', 'Objectif Sp√©cifique supprim√© avec succ√®s');
            $this->dispatch('refreshComponent');
            Log::info('‚úÖ Objectif Sp√©cifique supprim√©', ['osp_id' => $objectifSpecifiqueId]);

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur suppression Objectif Sp√©cifique', ['error' => $e->getMessage(), 'osp_id' => $objectifSpecifiqueId]);
            $this->dispatch('toast', 'error', 'Erreur lors de la suppression');
        }
    }

    public function updateAction()
    {
        if (!$this->editingAction) {
            $this->dispatch('toast', 'error', 'Aucune action √† modifier');
            return;
        }

        if (!$this->canEditAction($this->editingAction)) {
            $this->dispatch('toast', 'error', 'Permission refus√©e');
            return;
        }

        $this->validate([
            'editActionCode' => 'required|string|max:10',
            'editActionLibelle' => 'required|string|max:255',
            'editActionDescription' => 'nullable|string',
            'editActionOwnerId' => 'required|exists:users,id'
        ]);

        try {
            // Sauvegarder l'ancien propri√©taire pour la notification
            $oldOwnerId = $this->editingAction->owner_id;
            $newOwnerId = $this->editActionOwnerId;

            // Mettre √† jour l'action avec DB Query Builder
            $updated = DB::table('actions')
                ->where('id', $this->editingAction->id)
                ->update([
                    'code' => $this->editActionCode,
                    'libelle' => $this->editActionLibelle,
                    'description' => $this->editActionDescription,
                    'owner_id' => $this->editActionOwnerId,
                    'updated_at' => now()
                ]);

            if (!$updated) {
                Log::error('‚ùå √âchec de la mise √† jour de l\'action', ['action_id' => $this->editingAction->id]);
                $this->dispatch('toast', 'error', 'Erreur lors de la mise √† jour');
                return;
            }

            // Mettre √† jour l'objet local pour la suite
            $this->editingAction->code = $this->editActionCode;
            $this->editingAction->libelle = $this->editActionLibelle;
            $this->editingAction->description = $this->editActionDescription;
            $this->editingAction->owner_id = $this->editActionOwnerId;

            // Envoyer notification au nouveau propri√©taire s'il est diff√©rent
            if ($oldOwnerId != $newOwnerId) {
                Log::info('üìß Envoi notification changement responsable Action', [
                    'old_owner_id' => $oldOwnerId,
                    'new_owner_id' => $newOwnerId,
                    'action_id' => $this->editingAction->id,
                    'action_libelle' => $this->editingAction->libelle
                ]);

                $notificationSent = $this->sendNotification(
                    $newOwnerId,
                    'action_assigned',
                    'Action assign√©e',
                    "Vous avez √©t√© assign√© comme responsable de l'action : {$this->editingAction->libelle}",
                    ['action_id' => $this->editingAction->id, 'osp_id' => $this->selectedObjectifSpecifique->id]
                );

                if ($notificationSent) {
                    Log::info('‚úÖ Notification changement responsable Action envoy√©e avec succ√®s');
                } else {
                    Log::warning('‚ö†Ô∏è √âchec de l\'envoi de la notification changement responsable Action');
                }
            }

            // Mettre √† jour le taux d'avancement de l'objectif sp√©cifique parent avec DB
            $this->updateOSPProgressWithDB($this->selectedObjectifSpecifique->id);

            $this->closeEditActionModal();
            $this->dispatch('toast', 'success', 'Action modifi√©e avec succ√®s');
            $this->dispatch('refreshComponent');

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur mise √† jour Action', ['error' => $e->getMessage()]);
            $this->dispatch('toast', 'error', 'Erreur lors de la modification de l\'action');
        }
    }

    public function deleteAction($actionId)
    {
        try {
            Log::info('üóëÔ∏è Demande de suppression Action', [
                'action_id' => $actionId,
                'user_id' => Auth::id()
            ]);

            // V√©rifier les permissions avec DB
            $action = DB::table('actions')->where('id', $actionId)->first();
            
            if (!$action) {
                Log::warning('üö´ Action non trouv√©e', ['action_id' => $actionId]);
                $this->dispatch('toast', 'error', 'Action non trouv√©e');
                return;
            }

            if (!$this->canDeleteAction((object)$action)) {
                Log::warning('üö´ Permission refus√©e pour supprimer Action', ['user_id' => Auth::id(), 'action_id' => $actionId]);
                $this->dispatch('toast', 'error', 'Permission refus√©e ou action li√©e');
                return;
            }

            // Supprimer l'action avec DB
            $deleted = DB::table('actions')->where('id', $actionId)->delete();
            
            if (!$deleted) {
                Log::error('‚ùå √âchec de la suppression de l\'action', ['action_id' => $actionId]);
                $this->dispatch('toast', 'error', 'Erreur lors de la suppression');
                return;
            }

            // Mettre √† jour le taux d'avancement de l'objectif sp√©cifique parent avec DB
            $this->updateOSPProgressWithDB($this->selectedObjectifSpecifique->id);
            $this->dispatch('toast', 'success', 'Action supprim√©e avec succ√®s');
            $this->dispatch('refreshComponent');
            Log::info('‚úÖ Action supprim√©e', ['action_id' => $actionId]);

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur suppression Action', ['error' => $e->getMessage(), 'action_id' => $actionId]);
            $this->dispatch('error', 'Erreur lors de la suppression');
        }
    }



    /**
     * Mise √† jour rapide de la progression d'une sous-action via le slider
     */
    
    /**
     * Mise √† jour optimis√©e du taux d'avancement d'une Action
     */
    private function updateActionProgress($action)
    {
        try {
            // Calculer le taux d'avancement bas√© sur les sous-actions
            $sousActions = $action->sousActions;
            if ($sousActions->count() > 0) {
                $totalProgress = $sousActions->sum('taux_avancement');
                $averageProgress = $totalProgress / $sousActions->count();
                
                $action->taux_avancement = round($averageProgress, 2);
                $action->save();
                
                Log::info('‚úÖ Taux d\'avancement Action mis √† jour', [
                    'action_id' => $action->id,
                    'new_progress' => $action->taux_avancement
                ]);
            }
        } catch (\Exception $e) {
            Log::warning('‚ö†Ô∏è Erreur mise √† jour Action', ['error' => $e->getMessage(), 'action_id' => $action->id]);
        }
    }

    /**
     * Mise √† jour optimis√©e du taux d'avancement d'un Objectif Sp√©cifique
     */
    private function updateOSPProgress($objectifSpecifique)
    {
        try {
            // Calculer le taux d'avancement bas√© sur les actions
            $actions = $objectifSpecifique->actions;
            if ($actions->count() > 0) {
                $totalProgress = $actions->sum('taux_avancement');
                $averageProgress = $totalProgress / $actions->count();
                
                $objectifSpecifique->taux_avancement = round($averageProgress, 2);
                $objectifSpecifique->save();
                
                Log::info('‚úÖ Taux d\'avancement OSP mis √† jour', [
                    'osp_id' => $objectifSpecifique->id,
                    'new_progress' => $objectifSpecifique->taux_avancement
                ]);
            }
        } catch (\Exception $e) {
            Log::warning('‚ö†Ô∏è Erreur mise √† jour OSP', ['error' => $e->getMessage(), 'osp_id' => $objectifSpecifique->id]);
        }
    }

    /**
     * Mise √† jour optimis√©e du taux d'avancement d'un Objectif Strat√©gique
     */
    private function updateOSProgress($objectifStrategique)
    {
        try {
            // Calculer le taux d'avancement bas√© sur les objectifs sp√©cifiques
            $objectifsSpecifiques = $objectifStrategique->objectifsSpecifiques;
            if ($objectifsSpecifiques->count() > 0) {
                $totalProgress = $objectifsSpecifiques->sum('taux_avancement');
                $averageProgress = $totalProgress / $objectifsSpecifiques->count();
                
                $objectifStrategique->taux_avancement = round($averageProgress, 2);
                $objectifStrategique->save();
                
                Log::info('‚úÖ Taux d\'avancement OS mis √† jour', [
                    'os_id' => $objectifStrategique->id,
                    'new_progress' => $objectifStrategique->taux_avancement
                ]);
            }
        } catch (\Exception $e) {
            Log::warning('‚ö†Ô∏è Erreur mise √† jour OS', ['error' => $e->getMessage(), 'os_id' => $objectifStrategique->id]);
        }
    }

    /**
     * Mise √† jour optimis√©e du taux d'avancement d'un Pilier
     */
    private function updatePilierProgress($pilier)
    {
        try {
            // Calculer le taux d'avancement bas√© sur les objectifs strat√©giques
            $objectifsStrategiques = $pilier->objectifsStrategiques;
            if ($objectifsStrategiques->count() > 0) {
                $totalProgress = $objectifsStrategiques->sum('taux_avancement');
                $averageProgress = $totalProgress / $objectifsStrategiques->count();
                
                $pilier->taux_avancement = round($averageProgress, 2);
                $pilier->save();
                
                Log::info('‚úÖ Taux d\'avancement Pilier mis √† jour', [
                    'pilier_id' => $pilier->id,
                    'new_progress' => $pilier->taux_avancement
                ]);
            }
        } catch (\Exception $e) {
            Log::warning('‚ö†Ô∏è Erreur mise √† jour Pilier', ['error' => $e->getMessage(), 'pilier_id' => $pilier->id]);
        }
    }

    public function deleteSousAction($sousActionId)
    {
        try {
            Log::info('üóëÔ∏è Demande de suppression Sous-Action', [
                'sous_action_id' => $sousActionId,
                'user_id' => Auth::id()
            ]);

            // V√©rifier les permissions avec DB
            $sousAction = DB::table('sous_actions')->where('id', $sousActionId)->first();
            
            if (!$sousAction) {
                Log::warning('üö´ Sous-action non trouv√©e', ['sous_action_id' => $sousActionId]);
                $this->dispatch('toast', 'error', 'Sous-action non trouv√©e');
                return;
            }

            if (!$this->canDeleteSousAction((object)$sousAction)) {
                Log::warning('üö´ Permission refus√©e pour supprimer Sous-Action', ['user_id' => Auth::id(), 'sous_action_id' => $sousActionId]);
                $this->dispatch('toast', 'error', 'Permission refus√©e ou sous-action li√©e');
                return;
            }

            // Supprimer la sous-action avec DB
            $deleted = DB::table('sous_actions')->where('id', $sousActionId)->delete();
            
            if (!$deleted) {
                Log::error('‚ùå √âchec de la suppression de la sous-action', ['sous_action_id' => $sousActionId]);
                $this->dispatch('toast', 'error', 'Erreur lors de la suppression');
                return;
            }

            // Mettre √† jour le taux d'avancement de l'action parent avec DB
            $this->updateActionProgressWithDB($this->selectedAction->id);
            $this->dispatch('toast', 'success', 'Sous-action supprim√©e avec succ√®s');
            $this->dispatch('refreshComponent');
            Log::info('‚úÖ Sous-action supprim√©e', ['sous_action_id' => $sousActionId]);

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur suppression Sous-Action', ['error' => $e->getMessage(), 'sous_action_id' => $sousActionId]);
            $this->dispatch('toast', 'error', 'Erreur lors de la suppression');
        }
    }

    // Permissions
    public function canCreateObjectifStrategique()
    {
        $user = Auth::user();
        $isAdmin = method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral();
        
        Log::info('üîê V√©rification permission cr√©ation OS', [
            'user_id' => $user->id,
            'user_name' => $user->name,
            'is_admin' => $isAdmin,
            'method_exists' => method_exists($user, 'isAdminGeneral')
        ]);
        
        return $isAdmin;
    }

    public function canCreateObjectifSpecifique()
    {
        $user = Auth::user();
        return (method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral()) || 
               ($this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id);
    }

    public function canCreateAction()
    {
        $user = Auth::user();
        
        Log::info('üîê V√©rification permission cr√©ation Action', [
            'user_id' => $user->id,
            'user_name' => $user->name,
            'has_isAdminGeneral' => method_exists($user, 'isAdminGeneral'),
            'is_admin' => method_exists($user, 'isAdminGeneral') ? $user->isAdminGeneral() : 'M√©thode non trouv√©e',
            'selected_os_id' => $this->selectedObjectifStrategique ? $this->selectedObjectifStrategique->id : 'null',
            'selected_os_owner_id' => $this->selectedObjectifStrategique ? $this->selectedObjectifStrategique->owner_id : 'null',
            'selected_osp_id' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selected_osp_owner_id' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->owner_id : 'null',
            'user_is_os_owner' => $this->selectedObjectifStrategique ? ($user->id == $this->selectedObjectifStrategique->owner_id) : false,
            'user_is_osp_owner' => $this->selectedObjectifSpecifique ? ($user->id == $this->selectedObjectifSpecifique->owner_id) : false
        ]);
        
        $result = (method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral()) || 
               ($this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id) ||
               ($this->selectedObjectifSpecifique && $user->id == $this->selectedObjectifSpecifique->owner_id);
               
        Log::info('üîê R√©sultat permission cr√©ation Action', [
            'user_id' => $user->id,
            'permission_granted' => $result
        ]);
        
        return $result;
    }

    public function canCreateSousAction()
    {
        $user = Auth::user();
        return (method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral()) || 
               ($this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id) ||
               ($this->selectedObjectifSpecifique && $user->id == $this->selectedObjectifSpecifique->owner_id) ||
               ($this->selectedAction && $user->id == $this->selectedAction->owner_id);
    }

    public function canEditObjectifStrategique($objectifStrategique)
    {
        $user = Auth::user();
        return (method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral()) || $user->id == $objectifStrategique->owner_id;
    }

    public function canEditObjectifSpecifique($objectifSpecifique)
    {
        $user = Auth::user();
        return (method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral()) || 
               ($this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id) ||
               $user->id == $objectifSpecifique->owner_id;
    }

    public function canEditAction($action)
    {
        $user = Auth::user();
        return (method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral()) || 
               ($this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id) ||
               ($this->selectedObjectifSpecifique && $user->id == $this->selectedObjectifSpecifique->owner_id) ||
               $user->id == $action->owner_id;
    }

    public function canEditSousAction($sousAction)
    {
        $user = Auth::user();
        return (method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral()) || 
               ($this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id) ||
               ($this->selectedObjectifSpecifique && $user->id == $this->selectedObjectifSpecifique->owner_id) ||
               ($this->selectedAction && $user->id == $this->selectedAction->owner_id) ||
               $user->id == $sousAction->owner_id;
    }

    public function canDeleteObjectifStrategique($objectifStrategique)
    {
        $user = Auth::user();
        $isAdmin = method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral();
        $isOwner = $user->id == $objectifStrategique->owner_id;
        
        Log::info('üîê V√©rification permission suppression OS', [
            'user_id' => $user->id,
            'user_name' => $user->name,
            'is_admin' => $isAdmin,
            'is_owner' => $isOwner,
            'os_id' => $objectifStrategique->id,
            'os_libelle' => $objectifStrategique->libelle
        ]);
        
        // L'admin peut toujours supprimer
        if ($isAdmin) {
            Log::info('‚úÖ Admin autoris√© √† supprimer');
            return true;
        }
        
        // Le propri√©taire peut supprimer s'il n'y a pas d'objectifs sp√©cifiques
        if ($isOwner) {
            $hasChildren = $objectifStrategique->objectifsSpecifiques()->count() > 0;
            Log::info('üîç Propri√©taire - v√©rification enfants', ['has_children' => $hasChildren]);
            return !$hasChildren;
        }
        
        Log::info('‚ùå Permission refus√©e');
        return false;
    }

    public function canDeleteObjectifSpecifique($objectifSpecifique)
    {
        $user = Auth::user();
        $isAdmin = method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral();
        $isOSOwner = $this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id;
        $isOSPOwner = $user->id == $objectifSpecifique->owner_id;
        
        Log::info('üîê V√©rification permission suppression OSP', [
            'user_id' => $user->id,
            'is_admin' => $isAdmin,
            'is_os_owner' => $isOSOwner,
            'is_osp_owner' => $isOSPOwner,
            'osp_id' => $objectifSpecifique->id
        ]);
        
        // L'admin peut toujours supprimer
        if ($isAdmin) {
            return true;
        }
        
        // Le propri√©taire de l'OS parent ou de l'OSP peut supprimer
        if ($isOSOwner || $isOSPOwner) {
            $hasChildren = $objectifSpecifique->actions()->count() > 0;
            return !$hasChildren;
        }
        
        return false;
    }

    public function canDeleteAction($action)
    {
        $user = Auth::user();
        $isAdmin = method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral();
        $isOSOwner = $this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id;
        $isOSPOwner = $this->selectedObjectifSpecifique && $user->id == $this->selectedObjectifSpecifique->owner_id;
        $isActionOwner = $user->id == $action->owner_id;
        
        Log::info('üîê V√©rification permission suppression Action', [
            'user_id' => $user->id,
            'is_admin' => $isAdmin,
            'is_os_owner' => $isOSOwner,
            'is_osp_owner' => $isOSPOwner,
            'is_action_owner' => $isActionOwner,
            'action_id' => $action->id
        ]);
        
        // L'admin peut toujours supprimer
        if ($isAdmin) {
            return true;
        }
        
        // Les propri√©taires peuvent supprimer s'il n'y a pas de sous-actions
        if ($isOSOwner || $isOSPOwner || $isActionOwner) {
            $hasChildren = $action->sousActions()->count() > 0;
            return !$hasChildren;
        }
        
        return false;
    }

    public function canDeleteSousAction($sousAction)
    {
        $user = Auth::user();
        $isAdmin = method_exists($user, 'isAdminGeneral') && $user->isAdminGeneral();
        $isOSOwner = $this->selectedObjectifStrategique && $user->id == $this->selectedObjectifStrategique->owner_id;
        $isOSPOwner = $this->selectedObjectifSpecifique && $user->id == $this->selectedObjectifSpecifique->owner_id;
        $isActionOwner = $this->selectedAction && $user->id == $this->selectedAction->owner_id;
        $isSousActionOwner = $user->id == $sousAction->owner_id;
        
        Log::info('üîê V√©rification permission suppression Sous-Action', [
            'user_id' => $user->id,
            'is_admin' => $isAdmin,
            'is_os_owner' => $isOSOwner,
            'is_osp_owner' => $isOSPOwner,
            'is_action_owner' => $isActionOwner,
            'is_sous_action_owner' => $isSousActionOwner
        ]);
        
        // L'admin peut toujours supprimer
        if ($isAdmin) {
            return true;
        }
        
        // Les propri√©taires peuvent supprimer
        return $isOSOwner || $isOSPOwner || $isActionOwner || $isSousActionOwner;
    }

    // Utilitaires
    private function updateBreadcrumb()
    {
        $this->breadcrumb = [];
        
        if ($this->pilier) {
            $this->breadcrumb[] = [
                'label' => $this->pilier->code . ' - ' . $this->pilier->libelle,
                'action' => 'retourVersPilier'
            ];
        }
        
        if ($this->selectedObjectifStrategique) {
            $this->breadcrumb[] = [
                'label' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . ' - ' . $this->selectedObjectifStrategique->libelle,
                'action' => 'retourVersObjectifStrategique'
            ];
        }
        
        if ($this->selectedObjectifSpecifique) {
            $this->breadcrumb[] = [
                'label' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code . ' - ' . $this->selectedObjectifSpecifique->libelle,
                'action' => 'retourVersObjectifSpecifique'
            ];
        }
        
        if ($this->selectedAction) {
            $this->breadcrumb[] = [
                'label' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code . '.' . $this->selectedAction->code . ' - ' . $this->selectedAction->libelle,
                'action' => 'retourVersAction'
            ];
        }
        
        if ($this->selectedSousAction) {
            $this->breadcrumb[] = [
                'label' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code . '.' . $this->selectedAction->code . '.' . $this->selectedSousAction->code . ' - ' . $this->selectedSousAction->libelle,
                'action' => null
            ];
        }
    }

    private function sendNotification($userId, $type, $title, $message, $data = [])
    {
        try {
            $notificationId = DB::table('notifications')->insertGetId([
                'user_id' => $userId,
                'type' => $type,
                'title' => $title,
                'message' => $message,
                'data' => json_encode($data),
                'read_at' => null,
                'priority' => 'normal',
                'channel' => 'database',
                'created_at' => now(),
                'updated_at' => now()
            ]);

            Log::info('‚úÖ Notification envoy√©e avec succ√®s', [
                'notification_id' => $notificationId,
                'user_id' => $userId,
                'type' => $type,
                'title' => $title,
                'message' => $message
            ]);
            
            return true;

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur envoi notification', [
                'error' => $e->getMessage(),
                'user_id' => $userId,
                'type' => $type,
                'title' => $title
            ]);
            
            return false;
        }
    }

    private function resetSelections()
    {
        $this->selectedObjectifStrategique = null;
        $this->selectedObjectifSpecifique = null;
        $this->selectedAction = null;
        $this->selectedSousAction = null;
    }

    private function resetForms()
    {
        $this->resetNewOSForm();
        $this->resetNewOSPForm();
        $this->resetNewActionForm();
        $this->resetNewSousActionForm();
    }

    private function resetNewOSForm()
    {
        $this->newOS = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }

    private function resetNewOSPForm()
    {
        $this->newOSP = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }

    private function resetNewActionForm()
    {
        $this->newAction = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => '',
            'date_echeance' => '',
            'taux_avancement' => 0,
            'type' => 'normal'
        ];
    }

    private function resetNewSousActionForm()
    {
        $this->newSousAction = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => '',
            'date_echeance' => '',
            'taux_avancement' => 0
        ];
    }

    public function render()
    {
        $users = User::orderBy('name')->get();
        
        // Log pour d√©boguer
        $user = Auth::user();
        $isAdmin = method_exists($user, 'isAdminGeneral') ? $user->isAdminGeneral() : false;
        
        Log::info('üé® Rendu du composant PilierHierarchiqueV2', [
            'pilier_id' => $this->pilier?->id,
            'pilier_libelle' => $this->pilier?->libelle,
            'current_view' => $this->currentView,
            'user_id' => $user->id,
            'user_name' => $user->name,
            'is_admin' => $isAdmin,
            'method_exists' => method_exists($user, 'isAdminGeneral'),
            'permissions' => [
                'can_create_os' => $this->canCreateObjectifStrategique(),
                'can_create_osp' => $this->canCreateObjectifSpecifique(),
                'can_create_action' => $this->canCreateAction(),
                'can_create_sous_action' => $this->canCreateSousAction()
            ]
        ]);
        
        return view('livewire.pilier-hierarchique-v2.index', [
            'pilier' => $this->pilier,
            'objectifsStrategiques' => $this->pilier ? $this->pilier->objectifsStrategiques : collect(),
            'canCreateOS' => fn() => $this->canCreateObjectifStrategique(),
            'canEditOS' => fn($os) => $this->canEditObjectifStrategique($os),
            'canDeleteOS' => fn($os) => $this->canDeleteObjectifStrategique($os),
            'canCreateOSP' => fn() => $this->canCreateObjectifSpecifique(),
            'canEditOSP' => fn($osp) => $this->canEditObjectifSpecifique($osp),
            'canDeleteOSP' => fn($osp) => $this->canDeleteObjectifSpecifique($osp),
            'canCreateAction' => fn() => $this->canCreateAction(),
            'canEditAction' => fn($action) => $this->canEditAction($action),
            'canDeleteAction' => fn($action) => $this->canDeleteAction($action),
            'canCreateSousAction' => fn() => $this->canCreateSousAction(),
            'canEditSousAction' => fn($sousAction) => $this->canEditSousAction($sousAction),
            'canDeleteSousAction' => fn($sousAction) => $this->canDeleteSousAction($sousAction),
            'canEditActivity' => fn($activity) => $this->canEditActivity($activity),
            'canDeleteActivity' => fn($activity) => $this->canDeleteActivity($activity),
            'users' => User::all(), // Ajout de la liste des utilisateurs
        ]);
    }

    /**
     * Mise √† jour de la progression d'une sous-action avec DB Query Builder
     */
    public function updateSousActionProgress($sousActionId, $newProgress)
    {
        try {
            // Validation des param√®tres
            if (!is_numeric($newProgress) || $newProgress < 0 || $newProgress > 100) {
                $this->dispatch('toast', 'error', 'Valeur de progression invalide (0-100)');
                return;
            }

            // V√©rifier les permissions
            $sousAction = SousAction::findOrFail($sousActionId);
            if (!$this->canEditSousAction($sousAction)) {
                $this->dispatch('toast', 'error', 'Permission refus√©e');
                return;
            }

            // V√©rifier le type de sous-action
            if (($sousAction->type ?? 'normal') === 'projet') {
                $this->dispatch('toast', 'error', 'Impossible de modifier manuellement la progression d\'un projet. La progression est calcul√©e automatiquement.');
                return;
            }

            // Pr√©parer les donn√©es de mise √† jour
            $updateData = ['taux_avancement' => $newProgress];
            
            // Gestion de la date de r√©alisation et notification
            if ($newProgress == 100) {
                // Si exactement 100%, enregistrer la date de r√©alisation
                if (!$sousAction->date_realisation) {
                    $updateData['date_realisation'] = now();
                    
                    // Notifier le propri√©taire de la sous-action qu'elle est termin√©e
                    if ($sousAction->owner_id) {
                        $this->sendNotification(
                            $sousAction->owner_id,
                            'sous_action_completed',
                            'Sous-Action termin√©e ! üéâ',
                            "F√©licitations ! Votre sous-action '{$sousAction->libelle}' a √©t√© termin√©e avec succ√®s !",
                            [
                                'sous_action_id' => $sousAction->id,
                                'sous_action_libelle' => $sousAction->libelle,
                                'completion_date' => now()->toISOString()
                            ]
                        );
                        
                        Log::info('‚úÖ Notification de compl√©tion envoy√©e au propri√©taire de la sous-action', [
                            'sous_action_id' => $sousAction->id,
                            'owner_id' => $sousAction->owner_id,
                            'libelle' => $sousAction->libelle
                        ]);
                    }
                }
            } else {
                // Si diff√©rent de 100%, masquer la date de r√©alisation
                $updateData['date_realisation'] = null;
            }

            // Mettre √† jour avec DB Query Builder
            $updated = DB::table('sous_actions')
                ->where('id', $sousActionId)
                ->update($updateData);

            if (!$updated) {
                $this->dispatch('toast', 'error', 'Erreur lors de la mise √† jour');
                return;
            }

            // Mise √† jour des taux parents avec DB Query Builder
            $this->updateParentProgressRates($sousAction);

            // √âmettre l'√©v√©nement pour mettre √† jour les cercles de progression en temps r√©el
            $this->dispatch('progress-updated', [
                'action_progress' => $sousAction->action ? $sousAction->action->taux_avancement : null,
                'osp_progress' => $sousAction->action && $sousAction->action->objectifSpecifique ? $sousAction->action->objectifSpecifique->taux_avancement : null,
                'os_progress' => $sousAction->action && $sousAction->action->objectifSpecifique && $sousAction->action->objectifSpecifique->objectifStrategique ? $sousAction->action->objectifSpecifique->objectifStrategique->taux_avancement : null,
                'pilier_progress' => $sousAction->action && $sousAction->action->objectifSpecifique && $sousAction->action->objectifSpecifique->objectifStrategique && $sousAction->action->objectifSpecifique->objectifStrategique->pilier ? $sousAction->action->objectifSpecifique->objectifStrategique->pilier->taux_avancement : null
            ]);

            $this->dispatch('toast', 'success', 'Progression mise √† jour avec succ√®s');
            $this->dispatch('refreshComponent');

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur mise √† jour progression', [
                'error' => $e->getMessage(),
                'sous_action_id' => $sousActionId
            ]);
            
            $this->dispatch('toast', 'error', 'Erreur : ' . $e->getMessage());
        }
    }

    /**
     * Calcul automatique de la progression d'un projet
     * Cette m√©thode sera appel√©e automatiquement pour les sous-actions de type "projet"
     */
    public function calculateProjectProgress($sousActionId)
    {
        try {
            $sousAction = SousAction::findOrFail($sousActionId);
            
            // V√©rifier que c'est bien un projet
            if (($sousAction->type ?? 'normal') !== 'projet') {
                Log::warning('‚ö†Ô∏è Tentative de calcul de progression sur une sous-action non-projet', [
                    'sous_action_id' => $sousActionId,
                    'type' => $sousAction->type
                ]);
                return;
            }

            // Logique de calcul automatique de la progression
            // Pour l'instant, on peut utiliser une logique simple
            // √Ä adapter selon vos besoins m√©tier
            
            $newProgress = $this->calculateAutomaticProgress($sousAction);
            
            if ($newProgress !== null && $newProgress != $sousAction->taux_avancement) {
                // Mettre √† jour la progression
                $updateData = ['taux_avancement' => $newProgress];
                
                // Gestion de la date de r√©alisation et notification
                if ($newProgress == 100) {
                    if (!$sousAction->date_realisation) {
                        $updateData['date_realisation'] = now();
                        
                        // Notifier le propri√©taire de la sous-action projet qu'elle est termin√©e
                        if ($sousAction->owner_id) {
                            $this->sendNotification(
                                $sousAction->owner_id,
                                'projet_completed',
                                'Projet termin√© ! üéØ',
                                "F√©licitations ! Votre projet '{$sousAction->libelle}' a √©t√© termin√© avec succ√®s !",
                                [
                                    'sous_action_id' => $sousAction->id,
                                    'sous_action_libelle' => $sousAction->libelle,
                                    'completion_date' => now()->toISOString(),
                                    'type' => 'projet'
                                ]
                            );
                            
                            Log::info('‚úÖ Notification de compl√©tion de projet envoy√©e au propri√©taire', [
                                'sous_action_id' => $sousAction->id,
                                'owner_id' => $sousAction->owner_id,
                                'libelle' => $sousAction->libelle,
                                'type' => 'projet'
                            ]);
                        }
                    }
                } else {
                    $updateData['date_realisation'] = null;
                }

                // Mise √† jour avec DB Query Builder
                $updated = DB::table('sous_actions')
                    ->where('id', $sousActionId)
                    ->update($updateData);

                if ($updated) {
                    // Mise √† jour des taux parents
                    $this->updateParentProgressRates($sousAction);
                    
                    Log::info('‚úÖ Progression automatique du projet calcul√©e', [
                        'sous_action_id' => $sousActionId,
                        'ancien_taux' => $sousAction->taux_avancement,
                        'nouveau_taux' => $newProgress
                    ]);
                }
            }

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors du calcul automatique de la progression du projet', [
                'sous_action_id' => $sousActionId,
                'error' => $e->getMessage()
            ]);
        }
    }

    /**
     * Logique de calcul automatique de la progression
     * √Ä personnaliser selon vos besoins m√©tier
     */
    private function calculateAutomaticProgress($sousAction)
    {
        // Exemple de logique : progression bas√©e sur la date d'√©ch√©ance
        if ($sousAction->date_echeance) {
            $now = now();
            $echeance = \Carbon\Carbon::parse($sousAction->date_echeance);
            $creation = \Carbon\Carbon::parse($sousAction->created_at);
            
            $totalDays = $creation->diffInDays($echeance);
            $elapsedDays = $creation->diffInDays($now);
            
            if ($totalDays > 0) {
                $progress = min(100, max(0, ($elapsedDays / $totalDays) * 100));
                return round($progress, 2);
            }
        }
        
        // Si pas de date d'√©ch√©ance, retourner la progression actuelle
        return $sousAction->taux_avancement;
    }

    /**
     * Ouvrir le modal de gestion des activit√©s pour une sous-action
     */
    public function openActivitiesModal($sousActionId)
    {
        $this->selectedSousActionForActivities = SousAction::with('activities.owner')->findOrFail($sousActionId);
        $this->showActivitiesModal = true;
        $this->resetNewActivity();
        
        Log::info('üîì Modal des activit√©s ouvert', [
            'sous_action_id' => $sousActionId,
            'type' => $this->selectedSousActionForActivities->type
        ]);
    }

    /**
     * Fermer le modal de gestion des activit√©s
     */
    public function closeActivitiesModal()
    {
        $this->showActivitiesModal = false;
        $this->selectedSousActionForActivities = null;
        $this->resetNewActivity();
        $this->editingActivity = null;
    }

    /**
     * R√©initialiser le formulaire de nouvelle activit√©
     */
    public function resetNewActivity()
    {
        $this->newActivity = [
            'titre' => '',
            'description' => '',
            'date_debut' => '',
            'date_fin' => '',
            'statut' => 'en_attente',
            'taux_avancement' => 0,
            'owner_id' => auth()->id(),
            'tags' => []
        ];
    }

    /**
     * Cr√©er une nouvelle activit√©
     */
    public function createActivity()
    {
        $this->validate([
            'newActivity.titre' => 'required|string|max:255',
            'newActivity.description' => 'nullable|string',
            'newActivity.date_debut' => 'required|date',
            'newActivity.date_fin' => 'required|date|after:newActivity.date_debut',
            'newActivity.statut' => 'required|in:en_attente,en_cours,termine,bloque',
            'newActivity.taux_avancement' => 'required|numeric|min:0|max:100',
            'newActivity.owner_id' => 'required|exists:users,id',
        ]);

        // Validation suppl√©mentaire : la date de fin ne doit pas d√©passer l'√©ch√©ance du projet
        if ($this->selectedSousActionForActivities->date_echeance) {
            $this->validate([
                'newActivity.date_fin' => 'before_or_equal:' . $this->selectedSousActionForActivities->date_echeance,
            ], [
                'newActivity.date_fin.before_or_equal' => 'La date de fin de l\'activit√© ne peut pas d√©passer l\'√©ch√©ance du projet (' . \Carbon\Carbon::parse($this->selectedSousActionForActivities->date_echeance)->format('d/m/Y') . ')'
            ]);
        }

        try {
            $activityData = $this->newActivity;
            $activityData['sous_action_id'] = $this->selectedSousActionForActivities->id;
            $activityData['tags'] = json_encode($this->newActivity['tags']);

            $activityId = DB::table('activities')->insertGetId($activityData);

            if ($activityId) {
                // Recalculer la progression de la sous-action projet
                if ($this->selectedSousActionForActivities->type === 'projet') {
                    $this->recalculateProjectProgress($this->selectedSousActionForActivities->id);
                }

                $this->dispatch('toast', 'success', 'Activit√© cr√©√©e avec succ√®s !');
                $this->resetNewActivity();
                
                // Rafra√Æchir les donn√©es
                $this->selectedSousActionForActivities = SousAction::with('activities.owner')->find($this->selectedSousActionForActivities->id);
                
                Log::info('‚úÖ Activit√© cr√©√©e avec succ√®s', [
                    'activity_id' => $activityId,
                    'sous_action_id' => $this->selectedSousActionForActivities->id
                ]);
            }

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de la cr√©ation de l\'activit√©', [
                'error' => $e->getMessage(),
                'sous_action_id' => $this->selectedSousActionForActivities->id
            ]);
            
            $this->dispatch('toast', 'error', 'Erreur lors de la cr√©ation : ' . $e->getMessage());
        }
    }

    /**
     * Ouvrir le modal d'√©dition d'une activit√©
     */
    public function openEditActivityModal($activityId)
    {
        $activity = DB::table('activities')->find($activityId);
        if ($activity) {
            $this->editingActivity = $activity;
            $this->editActivityData = [
                'titre' => $activity->titre,
                'description' => $activity->description,
                'date_debut' => $activity->date_debut,
                'date_fin' => $activity->date_fin,
                'statut' => $activity->statut,
                'taux_avancement' => $activity->taux_avancement,
                'owner_id' => $activity->owner_id,
                'tags' => json_decode($activity->tags ?? '[]', true) ?: []
            ];
            
            Log::info('üîì Modal d\'√©dition d\'activit√© ouvert', [
                'activity_id' => $activityId,
                'titre' => $activity->titre
            ]);
        }
    }

    /**
     * Fermer le modal d'√©dition d'activit√©
     */
    public function closeEditActivityModal()
    {
        $this->editingActivity = null;
        $this->editActivityData = [];
    }

    /**
     * Mettre √† jour une activit√©
     */
    public function updateActivity()
    {
        // V√©rifier que l'activit√© √† √©diter est bien d√©finie
        if (!$this->editingActivity) {
            Log::error('‚ùå Tentative de mise √† jour d\'une activit√© non d√©finie', [
                'editingActivity' => $this->editingActivity,
                'editActivityData' => $this->editActivityData
            ]);
            $this->dispatch('toast', 'error', 'Aucune activit√© s√©lectionn√©e pour √©dition');
            return;
        }

        $this->validate([
            'editActivityData.titre' => 'required|string|max:255',
            'editActivityData.description' => 'nullable|string',
            'editActivityData.date_debut' => 'required|date',
            'editActivityData.date_fin' => 'required|date|after:editActivityData.date_debut',
            'editActivityData.statut' => 'required|in:en_attente,en_cours,termine,bloque',
            'editActivityData.taux_avancement' => 'required|numeric|min:0|max:100',
            'editActivityData.owner_id' => 'required|exists:users,id',
        ]);

        // Validation suppl√©mentaire : la date de fin ne doit pas d√©passer l'√©ch√©ance du projet
        if ($this->selectedSousActionForActivities->date_echeance) {
            $this->validate([
                'editActivityData.date_fin' => 'before_or_equal:' . $this->selectedSousActionForActivities->date_echeance,
            ], [
                'editActivityData.date_fin.before_or_equal' => 'La date de fin de l\'activit√© ne peut pas d√©passer l\'√©ch√©ance du projet (' . \Carbon\Carbon::parse($this->selectedSousActionForActivities->date_echeance)->format('d/m/Y') . ')'
            ]);
        }

        try {
            $activityId = $this->editingActivity->id;
            $updateData = $this->editActivityData;
            $updateData['tags'] = json_encode($this->editActivityData['tags']);

            Log::info('üîÑ D√©but de mise √† jour de l\'activit√©', [
                'activity_id' => $activityId,
                'update_data' => $updateData,
                'sous_action_id' => $this->selectedSousActionForActivities->id
            ]);

            $updated = DB::table('activities')
                ->where('id', $activityId)
                ->update($updateData);

            if ($updated) {
                // Recalculer la progression de la sous-action projet
                if ($this->selectedSousActionForActivities->type === 'projet') {
                    $this->recalculateProjectProgress($this->selectedSousActionForActivities->id);
                }

                $this->dispatch('toast', 'success', 'Activit√© mise √† jour avec succ√®s !');
                $this->closeEditActivityModal();
                
                // Rafra√Æchir les donn√©es
                $this->selectedSousActionForActivities = SousAction::with('activities.owner')->find($this->selectedSousActionForActivities->id);
                
                Log::info('‚úÖ Activit√© mise √† jour avec succ√®s', [
                    'activity_id' => $activityId,
                    'sous_action_id' => $this->selectedSousActionForActivities->id
                ]);
            } else {
                Log::warning('‚ö†Ô∏è Aucune modification effectu√©e lors de la mise √† jour de l\'activit√©', [
                    'activity_id' => $activityId
                ]);
                $this->dispatch('toast', 'warning', 'Aucune modification effectu√©e');
            }

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de la mise √† jour de l\'activit√©', [
                'error' => $e->getMessage(),
                'activity_id' => $this->editingActivity ? $this->editingActivity->id : 'null',
                'trace' => $e->getTraceAsString()
            ]);
            
            $this->dispatch('toast', 'error', 'Erreur lors de la mise √† jour : ' . $e->getMessage());
        }
    }

    /**
     * Supprimer une activit√©
     */
    public function deleteActivity($activityId)
    {
        try {
            $deleted = DB::table('activities')->where('id', $activityId)->delete();

            if ($deleted) {
                // Recalculer la progression de la sous-action projet
                if ($this->selectedSousActionForActivities->type === 'projet') {
                    $this->recalculateProjectProgress($this->selectedSousActionForActivities->id);
                }

                $this->dispatch('toast', 'success', 'Activit√© supprim√©e avec succ√®s !');
                
                // Rafra√Æchir les donn√©es
                $this->selectedSousActionForActivities = SousAction::with('activities.owner')->find($this->selectedSousActionForActivities->id);
                
                Log::info('‚úÖ Activit√© supprim√©e avec succ√®s', [
                    'activity_id' => $activityId,
                    'sous_action_id' => $this->selectedSousActionForActivities->id
                ]);
            }

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de la suppression de l\'activit√©', [
                'error' => $e->getMessage(),
                'activity_id' => $activityId
            ]);
            
            $this->dispatch('toast', 'error', 'Erreur lors de la suppression : ' . $e->getMessage());
        }
    }

    /**
     * Mettre √† jour la progression d'une activit√©
     */
    public function updateActivityProgress($activityId, $newProgress)
    {
        try {
            Log::info('üîÑ D√©but de mise √† jour de la progression d\'activit√©', [
                'activity_id' => $activityId,
                'nouvelle_progression' => $newProgress,
                'user_id' => Auth::id(),
                'timestamp' => now()->toISOString()
            ]);

            if (!is_numeric($newProgress) || $newProgress < 0 || $newProgress > 100) {
                Log::warning('‚ö†Ô∏è Valeur de progression invalide', [
                    'activity_id' => $activityId,
                    'nouvelle_progression' => $newProgress
                ]);
                $this->dispatch('toast', 'error', 'Valeur de progression invalide (0-100)');
                return;
            }

            // R√©cup√©rer l'activit√© avant mise √† jour pour comparer
            $activityBefore = DB::table('activities')->where('id', $activityId)->first();
            
            if (!$activityBefore) {
                Log::error('‚ùå Activit√© non trouv√©e lors de la mise √† jour de progression', [
                    'activity_id' => $activityId
                ]);
                $this->dispatch('toast', 'error', 'Activit√© non trouv√©e');
                return;
            }

            Log::info('üìä Activit√© trouv√©e avant mise √† jour', [
                'activity_id' => $activityId,
                'ancienne_progression' => $activityBefore->taux_avancement,
                'nouvelle_progression' => $newProgress,
                'titre' => $activityBefore->titre,
                'sous_action_id' => $activityBefore->sous_action_id,
                'owner_id' => $activityBefore->owner_id,
                'ancien_statut' => $activityBefore->statut
            ]);

            // V√©rifier si l'activit√© passe √† 100%
            $passeA100 = ($activityBefore->taux_avancement < 100 && $newProgress == 100);
            
            if ($passeA100) {
                Log::info('üéØ ACTIVIT√â PASSE √Ä 100% - Pr√©paration de la notification', [
                    'activity_id' => $activityId,
                    'ancienne_progression' => $activityBefore->taux_avancement,
                    'nouvelle_progression' => $newProgress,
                    'titre' => $activityBefore->titre,
                    'owner_id' => $activityBefore->owner_id
                ]);
            }

            // D√©terminer le nouveau statut
            $nouveauStatut = $newProgress >= 100 ? 'termine' : ($newProgress > 0 ? 'en_cours' : 'en_attente');
            
            Log::info('üîÑ Mise √† jour du statut de l\'activit√©', [
                'activity_id' => $activityId,
                'ancien_statut' => $activityBefore->statut,
                'nouveau_statut' => $nouveauStatut,
                'progression' => $newProgress
            ]);

            $updated = DB::table('activities')
                ->where('id', $activityId)
                ->update([
                    'taux_avancement' => $newProgress,
                    'statut' => $nouveauStatut
                ]);

            if (!$updated) {
                Log::error('‚ùå √âchec de la mise √† jour de la progression de l\'activit√©', [
                    'activity_id' => $activityId,
                    'nouvelle_progression' => $newProgress
                ]);
                $this->dispatch('toast', 'error', 'Erreur lors de la mise √† jour de la progression');
                return;
            }

            Log::info('‚úÖ Progression de l\'activit√© mise √† jour avec succ√®s', [
                'activity_id' => $activityId,
                'ancienne_progression' => $activityBefore->taux_avancement,
                'nouvelle_progression' => $newProgress,
                'ancien_statut' => $activityBefore->statut,
                'nouveau_statut' => $nouveauStatut,
                'updated_at' => now()->toISOString()
            ]);

            // R√©cup√©rer l'activit√© mise √† jour
            $activity = DB::table('activities')->where('id', $activityId)->first();
            
            if ($activity) {
                // Si l'activit√© passe √† 100%, envoyer une notification au propri√©taire
                if ($passeA100 && $activity->owner_id) {
                    Log::info('üîî ENVOI DE NOTIFICATION - Activit√© termin√©e √† 100%', [
                        'activity_id' => $activityId,
                        'owner_id' => $activity->owner_id,
                        'titre' => $activity->titre,
                        'progression' => $newProgress,
                        'sous_action_id' => $activity->sous_action_id
                    ]);

                    try {
                        $notificationSent = $this->sendNotification(
                            $activity->owner_id,
                            'activity_completed',
                            'Activit√© termin√©e ! üéØ',
                            "F√©licitations ! Votre activit√© '{$activity->titre}' a √©t√© termin√©e avec succ√®s !",
                            [
                                'activity_id' => $activity->id,
                                'activity_titre' => $activity->titre,
                                'completion_date' => now()->toISOString(),
                                'sous_action_id' => $activity->sous_action_id
                            ]
                        );

                        if ($notificationSent) {
                            Log::info('‚úÖ NOTIFICATION ENVOY√âE avec succ√®s pour l\'activit√© termin√©e', [
                                'activity_id' => $activityId,
                                'owner_id' => $activity->owner_id,
                                'notification_type' => 'activity_completed',
                                'timestamp' => now()->toISOString()
                            ]);
                        } else {
                            Log::warning('‚ö†Ô∏è √âchec de l\'envoi de la notification pour l\'activit√© termin√©e', [
                                'activity_id' => $activityId,
                                'owner_id' => $activity->owner_id
                            ]);
                        }
                    } catch (\Exception $notificationError) {
                        Log::error('‚ùå Erreur lors de l\'envoi de la notification pour l\'activit√© termin√©e', [
                            'activity_id' => $activityId,
                            'owner_id' => $activity->owner_id,
                            'error' => $notificationError->getMessage(),
                            'trace' => $notificationError->getTraceAsString()
                        ]);
                    }
                } else {
                    Log::info('‚ÑπÔ∏è Pas de notification n√©cessaire', [
                        'activity_id' => $activityId,
                        'passe_a_100' => $passeA100,
                        'owner_id' => $activity->owner_id,
                        'raison' => $passeA100 ? 'Pas de propri√©taire' : 'Progression diff√©rente de 100%'
                    ]);
                }

                // Recalculer la progression du projet
                if ($this->selectedSousActionForActivities->type === 'projet') {
                    Log::info('üîÑ D√©but du recalcul de la progression du projet', [
                        'sous_action_id' => $this->selectedSousActionForActivities->id,
                        'activity_id' => $activityId,
                        'type_sous_action' => $this->selectedSousActionForActivities->type
                    ]);

                    $this->recalculateProjectProgress($this->selectedSousActionForActivities->id);
                    
                    Log::info('‚úÖ Recalcul de la progression du projet termin√©', [
                        'sous_action_id' => $this->selectedSousActionForActivities->id,
                        'activity_id' => $activityId
                    ]);
                } else {
                    Log::info('‚ÑπÔ∏è Pas de recalcul n√©cessaire - Sous-action de type normal', [
                        'sous_action_id' => $this->selectedSousActionForActivities->id,
                        'type' => $this->selectedSousActionForActivities->type
                    ]);
                }

                $this->dispatch('toast', 'success', 'Progression de l\'activit√© mise √† jour !');
                
                // Rafra√Æchir les donn√©es
                $this->selectedSousActionForActivities = SousAction::with('activities.owner')->find($this->selectedSousActionForActivities->id);
                
                Log::info('üîÑ Donn√©es rafra√Æchies apr√®s mise √† jour', [
                    'activity_id' => $activityId,
                    'sous_action_id' => $this->selectedSousActionForActivities->id,
                    'timestamp' => now()->toISOString()
                ]);
            }

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors de la mise √† jour de la progression de l\'activit√©', [
                'activity_id' => $activityId,
                'nouvelle_progression' => $newProgress,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'timestamp' => now()->toISOString()
            ]);
            
            $this->dispatch('toast', 'error', 'Erreur : ' . $e->getMessage());
        }
    }

    /**
     * V√©rifier si l'utilisateur peut √©diter une activit√©
     */
    public function canEditActivity($activity)
    {
        $user = auth()->user();
        
        // L'admin g√©n√©ral peut tout faire
        if ($user->hasRole('admin_general')) {
            return true;
        }
        
        // Le propri√©taire de l'activit√© peut l'√©diter
        if ($activity->owner_id == $user->id) {
            return true;
        }
        
        // Le propri√©taire de la sous-action peut √©diter ses activit√©s
        $sousAction = SousAction::find($activity->sous_action_id);
        if ($sousAction && $sousAction->owner_id == $user->id) {
            return true;
        }
        
        // Le propri√©taire de l'action parent peut √©diter
        if ($sousAction && $sousAction->action) {
            $action = $sousAction->action;
            if ($action->owner_id == $user->id) {
                return true;
            }
            
            // V√©rifier la cha√Æne hi√©rarchique
            if ($action->objectifSpecifique && $action->objectifSpecifique->owner_id == $user->id) {
                return true;
            }
            
            if ($action->objectifSpecifique && $action->objectifSpecifique->objectifStrategique && 
                $action->objectifSpecifique->objectifStrategique->owner_id == $user->id) {
                return true;
            }
            
            if ($action->objectifSpecifique && $action->objectifSpecifique->objectifStrategique && 
                $action->objectifSpecifique->objectifStrategique->pilier && 
                $action->objectifSpecifique->objectifStrategique->pilier->owner_id == $user->id) {
                return true;
            }
        }
        
        return false;
    }

    /**
     * V√©rifier si l'utilisateur peut supprimer une activit√©
     */
    public function canDeleteActivity($activity)
    {
        $user = auth()->user();
        
        // L'admin g√©n√©ral peut tout faire
        if ($user->hasRole('admin_general')) {
            return true;
        }
        
        // Le propri√©taire de l'activit√© peut la supprimer
        if ($activity->owner_id == $user->id) {
            return true;
        }
        
        // Le propri√©taire de la sous-action peut supprimer ses activit√©s
        $sousAction = SousAction::find($activity->sous_action_id);
        if ($sousAction && $sousAction->owner_id == $user->id) {
            return true;
        }
        
        // Le propri√©taire de l'action parent peut supprimer
        if ($sousAction && $sousAction->action) {
            $action = $sousAction->action;
            if ($action->owner_id == $user->id) {
                return true;
            }
            
            // V√©rifier la cha√Æne hi√©rarchique
            if ($action->objectifSpecifique && $action->objectifSpecifique->owner_id == $user->id) {
                return true;
            }
            
            if ($action->objectifSpecifique && $action->objectifSpecifique->objectifStrategique && 
                $action->objectifSpecifique->objectifStrategique->owner_id == $user->id) {
                return true;
            }
            
            if ($action->objectifSpecifique && $action->objectifSpecifique->objectifStrategique && 
                $action->objectifSpecifique->objectifStrategique->pilier && 
                $action->objectifSpecifique->objectifStrategique->pilier->owner_id == $user->id) {
                return true;
            }
        }
        
        return false;
    }

    /**
     * Recalculer la progression d'un projet bas√©e sur ses activit√©s
     */
    private function recalculateProjectProgress($sousActionId)
    {
        try {
            Log::info('üîÑ D√©but du recalcul de la progression du projet', [
                'sous_action_id' => $sousActionId,
                'timestamp' => now()->toISOString()
            ]);

            // R√©cup√©rer la sous-action pour v√©rifier son type
            $sousAction = DB::table('sous_actions')->where('id', $sousActionId)->first();
            
            if (!$sousAction) {
                Log::error('‚ùå Sous-action non trouv√©e lors du recalcul de progression', [
                    'sous_action_id' => $sousActionId
                ]);
                return;
            }

            Log::info('üìä Informations de la sous-action projet', [
                'sous_action_id' => $sousActionId,
                'type' => $sousAction->type,
                'libelle' => $sousAction->libelle,
                'ancienne_progression' => $sousAction->taux_avancement,
                'owner_id' => $sousAction->owner_id
            ]);

            $activities = DB::table('activities')
                ->where('sous_action_id', $sousActionId)
                ->get();

            Log::info('üìã Activit√©s trouv√©es pour le projet', [
                'sous_action_id' => $sousActionId,
                'nombre_activites' => $activities->count(),
                'activites_details' => $activities->map(function($activity) {
                    return [
                        'id' => $activity->id,
                        'titre' => $activity->titre,
                        'taux_avancement' => $activity->taux_avancement,
                        'statut' => $activity->statut
                    ];
                })
            ]);

            if ($activities->count() > 0) {
                $totalProgress = $activities->sum('taux_avancement');
                $averageProgress = $totalProgress / $activities->count();
                $newProgress = round($averageProgress, 2);
                
                Log::info('üßÆ Calcul de la nouvelle progression du projet', [
                    'sous_action_id' => $sousActionId,
                    'total_progression_activites' => $totalProgress,
                    'nombre_activites' => $activities->count(),
                    'progression_moyenne' => $averageProgress,
                    'progression_arrondie' => $newProgress,
                    'ancienne_progression' => $sousAction->taux_avancement
                ]);

                // V√©rifier si le projet passe √† 100%
                $passeA100 = ($sousAction->taux_avancement < 100 && $newProgress == 100);
                
                if ($passeA100) {
                    Log::info('üéØ PROJET PASSE √Ä 100% - Pr√©paration de la notification', [
                        'sous_action_id' => $sousActionId,
                        'ancienne_progression' => $sousAction->taux_avancement,
                        'nouvelle_progression' => $newProgress,
                        'libelle' => $sousAction->libelle,
                        'owner_id' => $sousAction->owner_id
                    ]);
                }
                
                // Pr√©parer les donn√©es de mise √† jour
                $updateData = ['taux_avancement' => $newProgress];
                
                // Gestion de la date de r√©alisation pour les projets
                if ($newProgress == 100) {
                    // Si exactement 100%, enregistrer la date de r√©alisation
                    if (!$sousAction->date_realisation) {
                        $updateData['date_realisation'] = now();
                        
                        Log::info('üìÖ Date de r√©alisation ajout√©e au projet termin√©', [
                            'sous_action_id' => $sousActionId,
                            'date_realisation' => now()->toISOString(),
                            'libelle' => $sousAction->libelle
                        ]);
                    }
                } else {
                    // Si diff√©rent de 100%, masquer la date de r√©alisation
                    $updateData['date_realisation'] = null;
                    
                    if ($sousAction->date_realisation) {
                        Log::info('üìÖ Date de r√©alisation supprim√©e du projet (progression < 100%)', [
                            'sous_action_id' => $sousActionId,
                            'ancienne_date_realisation' => $sousAction->date_realisation,
                            'nouvelle_progression' => $newProgress
                        ]);
                    }
                }
                
                // Mettre √† jour la progression de la sous-action
                $updated = DB::table('sous_actions')
                    ->where('id', $sousActionId)
                    ->update($updateData);

                if ($updated) {
                    Log::info('‚úÖ Progression de la sous-action projet mise √† jour', [
                        'sous_action_id' => $sousActionId,
                        'ancienne_progression' => $sousAction->taux_avancement,
                        'nouvelle_progression' => $newProgress,
                        'timestamp' => now()->toISOString()
                    ]);

                    // Mettre √† jour les taux parents
                    $sousActionObj = SousAction::find($sousActionId);
                    if ($sousActionObj) {
                        Log::info('üîÑ D√©but de la mise √† jour des taux parents', [
                            'sous_action_id' => $sousActionId
                        ]);
                        
                        $this->updateParentProgressRates($sousActionObj);
                        
                        Log::info('‚úÖ Mise √† jour des taux parents termin√©e', [
                            'sous_action_id' => $sousActionId
                        ]);
                    } else {
                        Log::warning('‚ö†Ô∏è Impossible de r√©cup√©rer l\'objet SousAction pour la mise √† jour des parents', [
                            'sous_action_id' => $sousActionId
                        ]);
                    }
                } else {
                    Log::error('‚ùå √âchec de la mise √† jour de la progression de la sous-action projet', [
                        'sous_action_id' => $sousActionId,
                        'nouvelle_progression' => $newProgress
                    ]);
                }

                Log::info('‚úÖ Progression du projet recalcul√©e avec succ√®s', [
                    'sous_action_id' => $sousActionId,
                    'nombre_activites' => $activities->count(),
                    'ancienne_progression' => $sousAction->taux_avancement,
                    'nouvelle_progression' => $newProgress,
                    'timestamp' => now()->toISOString()
                ]);
            } else {
                Log::info('‚ÑπÔ∏è Aucune activit√© trouv√©e pour le projet', [
                    'sous_action_id' => $sousActionId
                ]);
            }

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur lors du recalcul de la progression du projet', [
                'sous_action_id' => $sousActionId,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'timestamp' => now()->toISOString()
            ]);
        }
    }

    /**
     * Mise √† jour des taux parents avec DB Query Builder
     */
    private function updateParentProgressRates($sousAction)
    {
        try {
            // 1. Mettre √† jour l'Action parente
            if ($sousAction->action_id) {
                $actionProgress = DB::table('sous_actions')
                    ->where('action_id', $sousAction->action_id)
                    ->avg('taux_avancement');
                
                $newActionProgress = round($actionProgress, 2);
                
                // R√©cup√©rer l'ancien taux pour v√©rifier si on passe √† 100%
                $oldActionProgress = DB::table('actions')
                    ->where('id', $sousAction->action_id)
                    ->value('taux_avancement');
                
                DB::table('actions')
                    ->where('id', $sousAction->action_id)
                    ->update(['taux_avancement' => $newActionProgress]);
                
                // Notifier si l'Action passe √† 100%
                if ($newActionProgress == 100 && $oldActionProgress != 100) {
                    $this->notifyParentCompletion('Action', $sousAction->action_id, $sousAction->action->owner_id ?? null);
                }
            }

            // 2. Mettre √† jour l'Objectif Sp√©cifique parent
            if ($sousAction->action && $sousAction->action->objectif_specifique_id) {
                $ospProgress = DB::table('actions')
                    ->where('objectif_specifique_id', $sousAction->action->objectif_specifique_id)
                    ->avg('taux_avancement');
                
                $newOSPProgress = round($ospProgress, 2);
                
                // R√©cup√©rer l'ancien taux
                $oldOSPProgress = DB::table('objectif_specifiques')
                    ->where('id', $sousAction->action->objectif_specifique_id)
                    ->value('taux_avancement');
                
                DB::table('objectif_specifiques')
                    ->where('id', $sousAction->action->objectif_specifique_id)
                    ->update(['taux_avancement' => $newOSPProgress]);
                
                // Notifier si l'OSP passe √† 100%
                if ($newOSPProgress == 100 && $oldOSPProgress != 100) {
                    $this->notifyParentCompletion('Objectif Sp√©cifique', $sousAction->action->objectif_specifique_id, $sousAction->action->objectifSpecifique->owner_id ?? null);
                }
            }

            // 3. Mettre √† jour l'Objectif Strat√©gique parent
            if ($sousAction->action && $sousAction->action->objectifSpecifique && $sousAction->action->objectifSpecifique->objectif_strategique_id) {
                $osProgress = DB::table('objectif_specifiques')
                    ->where('objectif_strategique_id', $sousAction->action->objectifSpecifique->objectif_strategique_id)
                    ->avg('taux_avancement');
                
                $newOSProgress = round($osProgress, 2);
                
                // R√©cup√©rer l'ancien taux
                $oldOSProgress = DB::table('objectif_strategiques')
                    ->where('id', $sousAction->action->objectifSpecifique->objectif_strategique_id)
                    ->value('taux_avancement');
                
                DB::table('objectif_strategiques')
                    ->where('id', $sousAction->action->objectifSpecifique->objectif_strategique_id)
                    ->update(['taux_avancement' => $newOSProgress]);
                
                // Notifier si l'OS passe √† 100%
                if ($newOSProgress == 100 && $oldOSProgress != 100) {
                    $this->notifyParentCompletion('Objectif Strat√©gique', $sousAction->action->objectifSpecifique->objectif_strategique_id, $sousAction->action->objectifSpecifique->objectifStrategique->owner_id ?? null);
                }
            }

            // 4. Mettre √† jour le Pilier parent
            if ($sousAction->action && $sousAction->action->objectifSpecifique && $sousAction->action->objectifSpecifique->objectifStrategique && $sousAction->action->objectifSpecifique->objectifStrategique->pilier_id) {
                $pilierProgress = DB::table('objectif_strategiques')
                    ->where('pilier_id', $sousAction->action->objectifSpecifique->objectifStrategique->pilier_id)
                    ->avg('taux_avancement');
                
                $newPilierProgress = round($pilierProgress, 2);
                
                // R√©cup√©rer l'ancien taux
                $oldPilierProgress = DB::table('piliers')
                    ->where('id', $sousAction->action->objectifSpecifique->objectifStrategique->pilier_id)
                    ->value('taux_avancement');
                
                DB::table('piliers')
                    ->where('id', $sousAction->action->objectifSpecifique->objectifStrategique->pilier_id)
                    ->update(['taux_avancement' => $newPilierProgress]);
                
                // Notifier si le Pilier passe √† 100%
                if ($newPilierProgress == 100 && $oldPilierProgress != 100) {
                    $this->notifyParentCompletion('Pilier', $sousAction->action->objectifSpecifique->objectifStrategique->pilier_id, $sousAction->action->objectifSpecifique->objectifStrategique->pilier->owner_id ?? null);
                }
            }

        } catch (\Exception $e) {
            Log::warning('‚ö†Ô∏è Erreur mise √† jour taux parents', [
                'error' => $e->getMessage(),
                'sous_action_id' => $sousAction->id
            ]);
        }
    }

    /**
     * Notifier le propri√©taire quand un parent passe √† 100%
     */
    private function notifyParentCompletion($parentType, $parentId, $ownerId)
    {
        if (!$ownerId) {
            Log::warning('‚ö†Ô∏è Pas de propri√©taire pour notifier', [
                'parent_type' => $parentType,
                'parent_id' => $parentId
            ]);
            return;
        }

        try {
            $notificationSent = $this->sendNotification(
                $ownerId,
                'parent_completion',
                'Objectif atteint ! üéâ',
                "F√©licitations ! Votre {$parentType} a atteint 100% de progression !",
                [
                    'parent_type' => $parentType,
                    'parent_id' => $parentId,
                    'completion_date' => now()->toISOString()
                ]
            );

            if ($notificationSent) {
                Log::info('‚úÖ Notification de compl√©tion envoy√©e', [
                    'parent_type' => $parentType,
                    'parent_id' => $parentId,
                    'owner_id' => $ownerId
                ]);
            } else {
                Log::warning('‚ö†Ô∏è √âchec envoi notification de compl√©tion', [
                    'parent_type' => $parentType,
                    'parent_id' => $parentId,
                    'owner_id' => $ownerId
                ]);
            }

        } catch (\Exception $e) {
            Log::error('‚ùå Erreur notification de compl√©tion', [
                'error' => $e->getMessage(),
                'parent_type' => $parentType,
                'parent_id' => $parentId,
                'owner_id' => $ownerId
            ]);
        }
    }

    // Propri√©t√©s d√©di√©es pour l'√©dition d'action (pour r√©soudre le binding)
    public $editActionCode = '';
    public $editActionLibelle = '';
    public $editActionDescription = '';
    public $editActionOwnerId = '';
    
    // Propri√©t√©s d√©di√©es pour l'√©dition de sous-action (pour r√©soudre le binding)
    public $editSousActionCode = '';
    public $editSousActionLibelle = '';
    public $editSousActionDescription = '';
    public $editSousActionOwnerId = '';
    public $editSousActionDateEcheance = '';
    public $editSousActionTauxAvancement = 0;
    public $editSousActionType = 'normal';
    
    // Propri√©t√©s pour la gestion des activit√©s
    public $selectedSousActionForActivities = null;
    public $showActivitiesModal = false;
    public $newActivity = [
        'titre' => '',
        'description' => '',
        'date_debut' => '',
        'date_fin' => '',
        'statut' => 'en_attente',
        'taux_avancement' => 0,
        'owner_id' => null,
        'tags' => []
    ];
    public $editingActivity = null;
    public $editActivityData = [
        'titre' => '',
        'description' => '',
        'date_debut' => '',
        'date_fin' => '',
        'statut' => 'en_attente',
        'taux_avancement' => 0,
        'owner_id' => null,
        'tags' => []
    ];
    
    // Nouvelle propri√©t√© pour contr√¥ler la visibilit√© du formulaire de cr√©ation d'activit√©
    public $showCreateActivityForm = false; // Masqu√© par d√©faut
    
    // Propri√©t√©s pour le calendrier des activit√©s
    public $showActivityCalendarModal = false;
    public $calendarMonth;
    public $calendarYear;
    public $calendarDays = [];
    
    // Propri√©t√©s pour le diagramme de Gantt
    public $showGanttChartModal = false;
    public $ganttMonth;
    public $ganttYear;
    
    // Propri√©t√©s pour l'√©dition d'objectif strat√©gique
    public $editingObjectifStrategique = null;
    public $editOSCode = '';
    public $editOSLibelle = '';
    public $editOSDescription = '';
    public $editOSOwnerId = '';

    /**
     * Mise √† jour optimis√©e du taux d'avancement d'une Action avec DB
     */
    private function updateActionProgressWithDB($actionId)
    {
        try {
            // Calculer le taux d'avancement bas√© sur les sous-actions avec DB
            $sousActions = DB::table('sous_actions')
                ->where('action_id', $actionId)
                ->get();
            
            if ($sousActions->count() > 0) {
                $totalProgress = $sousActions->sum('taux_avancement');
                $averageProgress = $totalProgress / $sousActions->count();
                $newProgress = round($averageProgress, 2);
                
                // R√©cup√©rer l'action pour v√©rifier si elle atteint 100%
                $action = DB::table('actions')->where('id', $actionId)->first();
                
                // Mettre √† jour avec DB
                DB::table('actions')
                    ->where('id', $actionId)
                    ->update([
                        'taux_avancement' => $newProgress,
                        'updated_at' => now()
                    ]);
                
                // Notification si l'action atteint 100%
                if ($newProgress == 100 && $action && $action->taux_avancement < 100) {
                    if ($action->owner_id) {
                        $this->sendNotification(
                            $action->owner_id,
                            'action_completed',
                            'Action termin√©e ! üéØ',
                            "F√©licitations ! Votre action '{$action->libelle}' a √©t√© termin√©e avec succ√®s !",
                            [
                                'action_id' => $action->id,
                                'action_libelle' => $action->libelle,
                                'completion_date' => now()->toISOString()
                            ]
                        );
                        
                        Log::info('‚úÖ Notification de compl√©tion d\'action envoy√©e au propri√©taire', [
                            'action_id' => $action->id,
                            'owner_id' => $action->owner_id,
                            'libelle' => $action->libelle
                        ]);
                    }
                }
                
                Log::info('‚úÖ Taux d\'avancement Action mis √† jour avec DB', [
                    'action_id' => $actionId,
                    'new_progress' => $newProgress
                ]);
            }
        } catch (\Exception $e) {
            Log::warning('‚ö†Ô∏è Erreur mise √† jour Action avec DB', [
                'error' => $e->getMessage(), 
                'action_id' => $actionId
            ]);
        }
    }

    /**
     * Mise √† jour optimis√©e du taux d'avancement d'un Objectif Sp√©cifique avec DB
     */
    private function updateOSPProgressWithDB($objectifSpecifiqueId)
    {
        try {
            // Calculer le taux d'avancement bas√© sur les actions avec DB
            $actions = DB::table('actions')
                ->where('objectif_specifique_id', $objectifSpecifiqueId)
                ->get();
            
            if ($actions->count() > 0) {
                $totalProgress = $actions->sum('taux_avancement');
                $averageProgress = $totalProgress / $actions->count();
                $newProgress = round($averageProgress, 2);
                
                // R√©cup√©rer l'objectif sp√©cifique pour v√©rifier s'il atteint 100%
                $objectifSpecifique = DB::table('objectif_specifiques')->where('id', $objectifSpecifiqueId)->first();
                
                // Mettre √† jour avec DB
                DB::table('objectif_specifiques')
                    ->where('id', $objectifSpecifiqueId)
                    ->update([
                        'taux_avancement' => $newProgress,
                        'updated_at' => now()
                    ]);
                
                // Notification si l'objectif sp√©cifique atteint 100%
                if ($newProgress == 100 && $objectifSpecifique && $objectifSpecifique->taux_avancement < 100) {
                    if ($objectifSpecifique->owner_id) {
                        $this->sendNotification(
                            $objectifSpecifique->owner_id,
                            'objectif_specifique_completed',
                            'Objectif Sp√©cifique termin√© ! üéØ',
                            "F√©licitations ! Votre objectif sp√©cifique '{$objectifSpecifique->libelle}' a √©t√© termin√© avec succ√®s !",
                            [
                                'objectif_specifique_id' => $objectifSpecifique->id,
                                'objectif_specifique_libelle' => $objectifSpecifique->libelle,
                                'completion_date' => now()->toISOString()
                            ]
                        );
                        
                        Log::info('‚úÖ Notification de compl√©tion d\'objectif sp√©cifique envoy√©e au propri√©taire', [
                            'objectif_specifique_id' => $objectifSpecifique->id,
                            'owner_id' => $objectifSpecifique->owner_id,
                            'libelle' => $objectifSpecifique->libelle
                        ]);
                    }
                }
                
                Log::info('‚úÖ Taux d\'avancement OSP mis √† jour avec DB', [
                    'osp_id' => $objectifSpecifiqueId,
                    'new_progress' => $newProgress
                ]);
            }
        } catch (\Exception $e) {
            Log::warning('‚ö†Ô∏è Erreur mise √† jour OSP avec DB', [
                'error' => $e->getMessage(), 
                'osp_id' => $objectifSpecifiqueId
            ]);
        }
    }

    /**
     * Ouvrir le modal du calendrier des activit√©s
     */
    public function openActivityCalendarModal()
    {
        $this->calendarMonth = now()->month;
        $this->calendarYear = now()->year;
        $this->generateCalendarDays();
        $this->showActivityCalendarModal = true;
        
        Log::info('üìÖ Modal du calendrier des activit√©s ouvert', [
            'sous_action_id' => $this->selectedSousActionForActivities->id,
            'month' => $this->calendarMonth,
            'year' => $this->calendarYear
        ]);
    }

    /**
     * Fermer le modal du calendrier des activit√©s
     */
    public function closeActivityCalendarModal()
    {
        $this->showActivityCalendarModal = false;
        $this->calendarDays = [];
    }

    /**
     * Aller au mois pr√©c√©dent
     */
    public function previousMonth()
    {
        if ($this->calendarMonth == 1) {
            $this->calendarMonth = 12;
            $this->calendarYear--;
        } else {
            $this->calendarMonth--;
        }
        
        $this->generateCalendarDays();
        
        Log::info('üìÖ Navigation vers le mois pr√©c√©dent', [
            'month' => $this->calendarMonth,
            'year' => $this->calendarYear
        ]);
    }

    /**
     * Aller au mois suivant
     */
    public function nextMonth()
    {
        if ($this->calendarMonth == 12) {
            $this->calendarMonth = 1;
            $this->calendarYear++;
        } else {
            $this->calendarMonth++;
        }
        
        $this->generateCalendarDays();
        
        Log::info('üìÖ Navigation vers le mois suivant', [
            'month' => $this->calendarMonth,
            'year' => $this->calendarYear
        ]);
    }

    /**
     * Aller au mois actuel
     */
    public function goToCurrentMonth()
    {
        $this->calendarMonth = now()->month;
        $this->calendarYear = now()->year;
        $this->generateCalendarDays();
        
        Log::info('üìÖ Retour au mois actuel', [
            'month' => $this->calendarMonth,
            'year' => $this->calendarYear
        ]);
    }

    /**
     * Afficher toutes les activit√©s d'un jour sp√©cifique
     */
    public function showDayActivities($date)
    {
        $formattedDate = \Carbon\Carbon::parse($date)->format('d/m/Y');
        $activities = $this->selectedSousActionForActivities->activities
            ->filter(function ($activity) use ($date) {
                $startDate = \Carbon\Carbon::parse($activity->date_debut);
                $endDate = \Carbon\Carbon::parse($activity->date_fin);
                $targetDate = \Carbon\Carbon::parse($date);
                
                return $targetDate->between($startDate, $endDate, true);
            });
        
        $this->dispatch('toast', 'info', "üìÖ {$activities->count()} activit√©(s) pour le {$formattedDate}");
        
        Log::info('üìÖ Affichage des activit√©s d\'un jour', [
            'date' => $date,
            'formatted_date' => $formattedDate,
            'activity_count' => $activities->count(),
            'sous_action_id' => $this->selectedSousActionForActivities->id
        ]);
    }

    /**
     * G√©n√©rer les jours du calendrier pour le mois et l'ann√©e donn√©s
     */
    private function generateCalendarDays()
    {
        $this->calendarDays = [];
        
        // Premier jour du mois
        $firstDayOfMonth = \Carbon\Carbon::createFromDate($this->calendarYear, $this->calendarMonth, 1);
        
        // Dernier jour du mois
        $lastDayOfMonth = $firstDayOfMonth->copy()->endOfMonth();
        
        // Premier jour de la semaine (lundi = 1)
        $firstDayOfWeek = $firstDayOfMonth->copy()->startOfWeek(\Carbon\Carbon::MONDAY);
        
        // Dernier jour de la semaine (dimanche = 0)
        $lastDayOfWeek = $lastDayOfMonth->copy()->endOfWeek(\Carbon\Carbon::SUNDAY);
        
        $currentDate = $firstDayOfWeek->copy();
        
        // R√©cup√©rer toutes les activit√©s du projet pour ce mois
        $allActivities = $this->selectedSousActionForActivities->activities
            ->filter(function ($activity) use ($firstDayOfWeek, $lastDayOfWeek) {
                $startDate = \Carbon\Carbon::parse($activity->date_debut);
                $endDate = \Carbon\Carbon::parse($activity->date_fin);
                
                // Une activit√© est visible si elle chevauche la p√©riode du mois
                return $startDate->lte($lastDayOfWeek) && $endDate->gte($firstDayOfWeek);
            });
        
        // Cr√©er un index des activit√©s par position
        $activityPositions = $this->createActivityPositions($allActivities, $firstDayOfWeek, $lastDayOfWeek);
        
        while ($currentDate->lte($lastDayOfWeek)) {
            $day = [
                'date' => $currentDate->copy(),
                'day' => $currentDate->day,
                'isCurrentMonth' => $currentDate->month == $this->calendarMonth,
                'isToday' => $currentDate->isToday(),
                'activities' => collect(),
                'activityPositions' => []
            ];
            
            // Si c'est un jour du mois actuel, r√©cup√©rer les activit√©s
            if ($day['isCurrentMonth']) {
                $day['activities'] = $allActivities
                    ->filter(function ($activity) use ($currentDate) {
                        $startDate = \Carbon\Carbon::parse($activity->date_debut);
                        $endDate = \Carbon\Carbon::parse($activity->date_fin);
                        
                        // Une activit√© est visible si elle commence, se termine ou est en cours ce jour-l√†
                        return $currentDate->between($startDate, $endDate, true);
                    });
                
                // Cr√©er les positions d'activit√©s pour ce jour
                $day['activityPositions'] = $this->getActivityPositionsForDay($currentDate, $activityPositions);
            }
            
            $this->calendarDays[] = $day;
            $currentDate->addDay();
        }
        
        Log::info('üìÖ Jours du calendrier g√©n√©r√©s avec alignement', [
            'month' => $this->calendarMonth,
            'year' => $this->calendarYear,
            'total_days' => count($this->calendarDays),
            'days_with_activities' => collect($this->calendarDays)->filter(fn($day) => $day['activities']->count() > 0)->count(),
            'max_activity_positions' => count($activityPositions)
        ]);
    }

    /**
     * Cr√©er un index des positions d'activit√©s pour le mois
     */
    private function createActivityPositions($activities, $startDate, $endDate)
    {
        $positions = [];
        $currentDate = $startDate->copy();
        
        while ($currentDate->lte($endDate)) {
            $dayActivities = $activities->filter(function ($activity) use ($currentDate) {
                $start = \Carbon\Carbon::parse($activity->date_debut);
                $end = \Carbon\Carbon::parse($activity->date_fin);
                return $currentDate->between($start, $end, true);
            });
            
            if ($dayActivities->count() > 0) {
                $positions[$currentDate->format('Y-m-d')] = $dayActivities->values();
            }
            
            $currentDate->addDay();
        }
        
        return $positions;
    }

    /**
     * Obtenir les positions d'activit√©s pour un jour sp√©cifique
     */
    private function getActivityPositionsForDay($date, $activityPositions)
    {
        $dateKey = $date->format('Y-m-d');
        $dayActivities = $activityPositions[$dateKey] ?? collect();
        
        // Cr√©er un tableau de positions avec des "slots" vides
        $maxPositions = $this->getMaxActivityPositions();
        $positions = array_fill(0, $maxPositions, null);
        
        foreach ($dayActivities as $index => $activity) {
            $positions[$index] = $activity;
        }
        
        return $positions;
    }

    /**
     * Obtenir le nombre maximum de positions d'activit√©s
     */
    private function getMaxActivityPositions()
    {
        $maxCount = 0;
        
        foreach ($this->calendarDays as $day) {
            if ($day['activities']->count() > $maxCount) {
                $maxCount = $day['activities']->count();
            }
        }
        
        return max($maxCount, 1); // Au moins 1 position
    }

    /**
     * Ouvrir le modal du diagramme de Gantt
     */
    public function openGanttChartModal()
    {
        $this->ganttMonth = now()->month;
        $this->ganttYear = now()->year;
        $this->showGanttChartModal = true;
        
        Log::info('üìä Modal du diagramme de Gantt ouvert', [
            'sous_action_id' => $this->selectedSousActionForActivities->id,
            'month' => $this->ganttMonth,
            'year' => $this->ganttYear
        ]);
    }

    /**
     * Fermer le modal du diagramme de Gantt
     */
    public function closeGanttChartModal()
    {
        $this->showGanttChartModal = false;
    }

    /**
     * Aller √† la p√©riode pr√©c√©dente du Gantt
     */
    public function previousGanttPeriod()
    {
        if ($this->ganttMonth == 1) {
            $this->ganttMonth = 12;
            $this->ganttYear--;
        } else {
            $this->ganttMonth--;
        }
        
        Log::info('üìä Navigation vers la p√©riode pr√©c√©dente du Gantt', [
            'month' => $this->ganttMonth,
            'year' => $this->ganttYear
        ]);
    }

    /**
     * Aller √† la p√©riode suivante du Gantt
     */
    public function nextGanttPeriod()
    {
        if ($this->ganttMonth == 12) {
            $this->ganttMonth = 1;
            $this->ganttYear++;
        } else {
            $this->ganttMonth++;
        }
        
        Log::info('üìä Navigation vers la p√©riode suivante du Gantt', [
            'month' => $this->ganttMonth,
            'year' => $this->ganttYear
        ]);
    }

    /**
     * Aller √† la p√©riode actuelle du Gantt
     */
    public function goToCurrentGanttPeriod()
    {
        $this->ganttMonth = now()->month;
        $this->ganttYear = now()->year;
        
        Log::info('üìä Retour √† la p√©riode actuelle du Gantt', [
            'month' => $this->ganttMonth,
            'year' => $this->ganttYear
        ]);
    }

    /**
     * Calculer la position de la barre Gantt
     */
    public function calculateGanttBarPosition($activity)
    {
        $startDate = \Carbon\Carbon::parse($activity->date_debut);
        $monthStart = \Carbon\Carbon::createFromDate($this->ganttYear, $this->ganttMonth, 1);
        $monthEnd = $monthStart->copy()->endOfMonth();
        
        if ($startDate->lt($monthStart)) {
            return 0;
        }
        
        $daysFromStart = $startDate->diffInDays($monthStart);
        $totalDays = $monthStart->diffInDays($monthEnd) + 1;
        
        return ($daysFromStart / $totalDays) * 100;
    }

    /**
     * Calculer la largeur de la barre Gantt
     */
    public function calculateGanttBarWidth($activity)
    {
        $startDate = \Carbon\Carbon::parse($activity->date_debut);
        $endDate = \Carbon\Carbon::parse($activity->date_fin);
        $monthStart = \Carbon\Carbon::createFromDate($this->ganttYear, $this->ganttMonth, 1);
        $monthEnd = $monthStart->copy()->endOfMonth();
        
        // Ajuster les dates pour le mois affich√©
        $effectiveStart = $startDate->lt($monthStart) ? $monthStart : $startDate;
        $effectiveEnd = $endDate->gt($monthEnd) ? $monthEnd : $endDate;
        
        $duration = $effectiveEnd->diffInDays($effectiveStart) + 1;
        $totalDays = $monthStart->diffInDays($monthEnd) + 1;
        
        return min(($duration / $totalDays) * 100, 100);
    }

}
