<?php

namespace App\Livewire;

use Livewire\Component;
use App\Models\Pilier;
use App\Models\ObjectifStrategique;
use App\Models\ObjectifSpecifique;
use App\Models\Action;
use App\Models\SousAction;
use App\Models\User;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;
use App\Notifications\ObjectifStrategiqueAssigned;

class PilierHierarchiqueModal extends Component
{
    // Debug: Composant recharg√© pour corriger les m√©thodes manquantes
    public $showModal = false;
    

    
    // M√©thodes d'√©dition avec la m√™me logique que PilierDetailsModalNew
    public function setActionToEditObjectifStrategique($objectifStrategiqueId)
    {
        $this->dispatch('console.log', 'üöÄ setActionToEditObjectifStrategique appel√©e pour ID: ' . $objectifStrategiqueId);
        
        try {
            $objectifStrategique = ObjectifStrategique::find($objectifStrategiqueId);
            if ($objectifStrategique) {
                $this->editingObjectifStrategique = [
                    'id' => $objectifStrategique->id,
                    'code' => $objectifStrategique->code,
                    'libelle' => $objectifStrategique->libelle,
                    'description' => $objectifStrategique->description,
                    'owner_id' => $objectifStrategique->owner_id ?: ''
                ];
                $this->showEditObjectifStrategiqueForm = true;
                $this->dispatch('console.log', '‚úÖ Donn√©es d\'√©dition charg√©es pour objectif strat√©gique');
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur lors du chargement des donn√©es d\'√©dition: ' . $e->getMessage());
        }
    }
    
    public function setActionToEditObjectifSpecifique($objectifSpecifiqueId)
    {
        $this->dispatch('console.log', 'üöÄ setActionToEditObjectifSpecifique appel√©e pour ID: ' . $objectifSpecifiqueId);
        
        try {
            $objectifSpecifique = ObjectifSpecifique::find($objectifSpecifiqueId);
            if ($objectifSpecifique) {
                $this->editingObjectifSpecifique = [
                    'id' => $objectifSpecifique->id,
                    'code' => $objectifSpecifique->code,
                    'libelle' => $objectifSpecifique->libelle,
                    'description' => $objectifSpecifique->description,
                    'owner_id' => $objectifSpecifique->owner_id ?: ''
                ];
                $this->showEditObjectifSpecifiqueForm = true;
                $this->dispatch('console.log', '‚úÖ Donn√©es d\'√©dition charg√©es pour objectif sp√©cifique');
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur lors du chargement des donn√©es d\'√©dition: ' . $e->getMessage());
        }
    }
    
    public function setActionToEditAction($actionId)
    {
        $this->dispatch('console.log', 'üöÄ setActionToEditAction appel√©e pour ID: ' . $actionId);
        
        try {
            $action = Action::find($actionId);
            if ($action) {
                $this->editingAction = [
                    'id' => $action->id,
                    'code' => $action->code,
                    'libelle' => $action->libelle,
                    'description' => $action->description,
                    'owner_id' => $action->owner_id ?: ''
                ];
                $this->showEditActionForm = true;
                $this->dispatch('console.log', '‚úÖ Donn√©es d\'√©dition charg√©es pour action');
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur lors du chargement des donn√©es d\'√©dition: ' . $e->getMessage());
        }
    }
    
    public function setActionToEditSousAction($sousActionId)
    {
        $this->dispatch('console.log', 'üöÄ setActionToEditSousAction appel√©e pour ID: ' . $sousActionId);
        
        try {
            $sousAction = SousAction::find($sousActionId);
            if ($sousAction) {
                $this->editingSousAction = [
                    'id' => $sousAction->id,
                    'code' => $sousAction->code,
                    'libelle' => $sousAction->libelle,
                    'description' => $sousAction->description,
                    'owner_id' => $sousAction->owner_id ?: '',
                    'date_echeance' => $sousAction->date_echeance ?: '',
                    'taux_avancement' => $sousAction->taux_avancement
                ];
                $this->showEditSousActionForm = true;
                $this->dispatch('console.log', '‚úÖ Donn√©es d\'√©dition charg√©es pour sous-action');
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur lors du chargement des donn√©es d\'√©dition: ' . $e->getMessage());
        }
    }
    public $pilierId = null;
    public $pilier = null;
    public $isLoading = true;
    public $searchTerm = '';
    
    // Navigation et √©tats
    public $currentView = 'pilier'; // pilier, objectifStrategique, objectifSpecifique, action, sousAction
    public $breadcrumb = [];
    
    // Donn√©es s√©lectionn√©es
    public $selectedObjectifStrategique = null;
    public $selectedObjectifSpecifique = null;
    public $selectedAction = null;
    public $selectedSousAction = null;
    
    // Formulaires de cr√©ation
    public $showCreateObjectifForm = false;
    public $showCreateObjectifSpecifiqueForm = false;
    public $showCreateActionForm = false;
    public $showCreateSousActionForm = false;
    
    // Formulaires d'√©dition
    public $showEditObjectifStrategiqueForm = false;
    public $showEditObjectifSpecifiqueForm = false;
    public $showEditActionForm = false;
    public $showEditSousActionForm = false;
    
    // Donn√©es des formulaires
    public $newObjectifStrategique = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];
    
    public $newObjectifSpecifique = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];
    
    public $newAction = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];
    
    public $newSousAction = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'type' => '',
        'owner_id' => '',
        'date_echeance' => '',
        'taux_avancement' => 0
    ];
    

    
    // Donn√©es d'√©dition
    public $editObjectifStrategique = [];
    public $editObjectifSpecifique = [];
    public $editAction = [];
    public $editSousAction = [];
    
    // Donn√©es d'√©dition avec wire:model
    public $editingObjectifStrategique = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];
    
    public $editingObjectifSpecifique = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];
    
    public $editingAction = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'owner_id' => ''
    ];
    
    public $editingSousAction = [
        'code' => '',
        'libelle' => '',
        'description' => '',
        'type' => '',
        'owner_id' => '',
        'date_echeance' => '',
        'date_realisation' => '',
        'taux_avancement' => 0
    ];
    

    
    // D√©tails s√©lectionn√©s
    public $selectedObjectifStrategiqueDetails = null;
    public $selectedObjectifSpecifiqueDetails = null;
    public $selectedActionDetails = null;
    public $selectedSousActionDetails = null;
    
    // √âtats de chargement
    public $isLoadingObjectifs = false;
    public $isLoadingObjectifsSpecifiques = false;
    public $isLoadingActions = false;
    public $isLoadingSousActions = false;
    
    // √âtats des modals
    
    // Propri√©t√© pour identifier le composant
    public $componentType = 'hierarchique';
    
    // Propri√©t√© users comme fallback
    public $users = [];
    
    // Propri√©t√© de d√©bogage pour le slider
    public $debugSliderValue = 0;

    protected $listeners = [
        'openPilierHierarchiqueModal' => 'openModal',
        'refreshHierarchique' => 'loadPilierData'
    ];

    public function mount()
    {
        $this->resetFormData();
        $this->users = $this->getUsersProperty();
    }

    public function openModal($data = null)
    {
        if ($data === null) {
            Log::info('üîÑ [HIERARCHIQUE] Appel automatique ignor√©');
            return; // √âviter l'appel automatique par Livewire
        }
        
        $pilierId = is_array($data) ? $data['pilierId'] : $data;
        Log::info('üîÑ [HIERARCHIQUE] M√©thode openModal appel√©e avec pilierId: ' . $pilierId);
        $this->pilierId = $pilierId;
        $this->showModal = true;
        $this->loadPilierData();
        $this->resetNavigation();
        Log::info('‚úÖ [HIERARCHIQUE] Modal ouvert, showModal = ' . ($this->showModal ? 'true' : 'false'));
    }

    public function closeModal()
    {
        $this->showModal = false;
        $this->resetFormData();
        $this->resetNavigation();
    }

    public function loadPilierData()
    {
        try {
            $this->isLoading = true;
            
            $this->pilier = Pilier::with([
                'objectifsStrategiques.objectifsSpecifiques.actions.sousActions',
                'objectifsStrategiques.objectifsSpecifiques.actions.owner',
                'objectifsStrategiques.objectifsSpecifiques.owner',
                'objectifsStrategiques.owner',
                'owner'
            ])->find($this->pilierId);
            
            if (!$this->pilier) {
                $this->dispatch('showToast', ['type' => 'error', 'message' => 'Pilier non trouv√©']);
                return;
            }
            
            Log::info('Vue Hi√©rarchique - Donn√©es du pilier charg√©es', ['pilier_id' => $this->pilierId]);
            
            // Mettre √† jour la liste des users
            $this->users = $this->getUsersProperty();
            
        } catch (\Exception $e) {
            Log::error('Erreur lors du chargement des donn√©es du pilier', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors du chargement des donn√©es']);
        } finally {
            $this->isLoading = false;
        }
    }

    public function resetNavigation()
    {
        $this->currentView = 'pilier';
        $this->breadcrumb = [];
        $this->selectedObjectifStrategique = null;
        $this->selectedObjectifSpecifique = null;
        $this->selectedAction = null;
        $this->selectedSousAction = null;
        $this->selectedObjectifStrategiqueDetails = null;
        $this->selectedObjectifSpecifiqueDetails = null;
        $this->selectedActionDetails = null;
        $this->selectedSousActionDetails = null;
    }

    public function resetFormData()
    {
        $this->newObjectifStrategique = ['code' => '', 'libelle' => '', 'description' => '', 'owner_id' => ''];
        $this->newObjectifSpecifique = ['code' => '', 'libelle' => '', 'description' => '', 'owner_id' => ''];
        $this->newAction = ['code' => '', 'libelle' => '', 'description' => '', 'owner_id' => ''];

        
        $this->editObjectifStrategique = [];
        $this->editObjectifSpecifique = [];
        $this->editAction = [];
        $this->editSousAction = [];
        
        // R√©initialiser les propri√©t√©s d'affichage des formulaires
        $this->showCreateObjectifForm = false;
        $this->showCreateObjectifSpecifiqueForm = false;
        $this->showCreateActionForm = false;
        $this->showCreateSousActionForm = false;
        $this->showEditObjectifStrategiqueForm = false;
        $this->showEditObjectifSpecifiqueForm = false;
        $this->showEditActionForm = false;
    }

    // Navigation
    public function naviguerVersObjectifStrategique($objectifStrategiqueId)
    {
        $this->dispatch('console.log', 'DEBUG: naviguerVersObjectifStrategique - AVANT navigation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);

        $this->selectedObjectifStrategique = ObjectifStrategique::with(['objectifsSpecifiques.actions.sousActions'])->find($objectifStrategiqueId);
        $this->currentView = 'objectifStrategique';
        $this->breadcrumb = [
            ['type' => 'pilier', 'name' => $this->pilier->code, 'id' => $this->pilier->id],
            ['type' => 'objectifStrategique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code, 'id' => $objectifStrategiqueId]
        ];

        $this->dispatch('console.log', 'DEBUG: naviguerVersObjectifStrategique - APR√àS navigation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);
    }

    public function naviguerVersObjectifSpecifique($objectifSpecifiqueId)
    {
        $this->dispatch('console.log', 'DEBUG: naviguerVersObjectifSpecifique - AVANT navigation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);

        $this->selectedObjectifSpecifique = ObjectifSpecifique::with(['actions.sousActions'])->find($objectifSpecifiqueId);
        $this->currentView = 'objectifSpecifique';
        $this->breadcrumb = [
            ['type' => 'pilier', 'name' => $this->pilier->code, 'id' => $this->pilier->id],
            ['type' => 'objectifStrategique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code, 'id' => $this->selectedObjectifStrategique->id],
            ['type' => 'objectifSpecifique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code, 'id' => $objectifSpecifiqueId]
        ];

        $this->dispatch('console.log', 'DEBUG: naviguerVersObjectifSpecifique - APR√àS navigation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);
    }

    public function naviguerVersAction($actionId)
    {
        $this->dispatch('console.log', 'DEBUG: naviguerVersAction - AVANT navigation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);

        $this->selectedAction = Action::with(['sousActions'])->find($actionId);
        $this->currentView = 'action';
        
        // Log d√©taill√© de l'action et de ses sous-actions
        $this->dispatch('console.log', 'DEBUG: Action charg√©e:', [
            'action_id' => $this->selectedAction->id,
            'action_code' => $this->selectedAction->code,
            'action_libelle' => $this->selectedAction->libelle,
            'sous_actions_count' => $this->selectedAction->sousActions->count(),
            'sous_actions' => $this->selectedAction->sousActions->map(function($sa) {
                return ['id' => $sa->id, 'code' => $sa->code, 'libelle' => $sa->libelle];
            })
        ]);
        
        $this->breadcrumb = [
            ['type' => 'pilier', 'name' => $this->pilier->code, 'id' => $this->pilier->id],
            ['type' => 'objectifStrategique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code, 'id' => $this->selectedObjectifStrategique->id],
            ['type' => 'objectifSpecifique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code, 'id' => $this->selectedObjectifSpecifique->id],
            ['type' => 'action', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code . '.' . $this->selectedAction->code, 'id' => $actionId]
        ];

        $this->dispatch('console.log', 'DEBUG: naviguerVersAction - APR√àS navigation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);
    }

    public function naviguerVersSousAction($sousActionId)
    {
        $this->selectedSousAction = SousAction::find($sousActionId);
        $this->currentView = 'sousAction';
        $this->breadcrumb = [
            ['type' => 'pilier', 'name' => $this->pilier->code, 'id' => $this->pilier->id],
            ['type' => 'objectifStrategique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code, 'id' => $this->selectedObjectifStrategique->id],
            ['type' => 'objectifSpecifique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code, 'id' => $this->selectedObjectifSpecifique->id],
            ['type' => 'action', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code . '.' . $this->selectedAction->code, 'id' => $this->selectedAction->id],
            ['type' => 'sousAction', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code . '.' . $this->selectedAction->code . '.' . $this->selectedSousAction->code, 'id' => $sousActionId]
        ];
    }

    public function retourListeObjectifs()
    {
        $this->currentView = 'pilier';
        $this->breadcrumb = [];
        $this->selectedObjectifStrategique = null;
        $this->selectedObjectifStrategiqueDetails = null;
    }
    
    public function naviguerVersPilier()
    {
        $this->currentView = 'pilier';
        $this->breadcrumb = [];
        $this->selectedObjectifStrategique = null;
        $this->selectedObjectifSpecifique = null;
        $this->selectedAction = null;
        $this->selectedSousAction = null;
        $this->selectedObjectifStrategiqueDetails = null;
        $this->selectedObjectifSpecifiqueDetails = null;
        $this->selectedActionDetails = null;
        $this->selectedSousActionDetails = null;
    }

    public function retourListeObjectifsSpecifiques()
    {
        $this->dispatch('console.log', 'DEBUG: retourListeObjectifsSpecifiques - AVANT r√©initialisation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);

        $this->currentView = 'objectifStrategique';
        $this->breadcrumb = [
            ['type' => 'pilier', 'name' => $this->pilier->code, 'id' => $this->pilier->id],
            ['type' => 'objectifStrategique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code, 'id' => $this->selectedObjectifStrategique->id]
        ];
        $this->selectedObjectifSpecifique = null;
        $this->selectedObjectifSpecifiqueDetails = null;
        $this->selectedAction = null;
        $this->selectedActionDetails = null;
        $this->selectedSousAction = null;
        $this->selectedSousActionDetails = null;

        $this->dispatch('console.log', 'DEBUG: retourListeObjectifsSpecifiques - APR√àS r√©initialisation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);
    }

    public function retourListeActions()
    {
        $this->dispatch('console.log', 'DEBUG: retourListeActions - AVANT r√©initialisation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);

        $this->currentView = 'objectifSpecifique';
        $this->breadcrumb = [
            ['type' => 'pilier', 'name' => $this->pilier->code, 'id' => $this->pilier->id],
            ['type' => 'objectifStrategique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code, 'id' => $this->selectedObjectifStrategique->id],
            ['type' => 'objectifSpecifique', 'name' => $this->pilier->code . '.' . $this->selectedObjectifStrategique->code . '.' . $this->selectedObjectifSpecifique->code, 'id' => $this->selectedObjectifSpecifique->id]
        ];
        $this->selectedAction = null;
        $this->selectedActionDetails = null;
        $this->selectedSousAction = null;
        $this->selectedSousActionDetails = null;

        $this->dispatch('console.log', 'DEBUG: retourListeActions - APR√àS r√©initialisation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);
    }

    public function retourListeSousActions()
    {
        $this->dispatch('console.log', 'DEBUG: retourListeSousActions - AVANT r√©initialisation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);

        $this->currentView = 'action';
        $this->breadcrumb = [
            ['type' => 'pilier', 'name' => $this->pilier->libelle, 'id' => $this->pilier->id],
            ['type' => 'objectifStrategique', 'name' => $this->selectedObjectifStrategique->libelle, 'id' => $this->selectedObjectifStrategique->id],
            ['type' => 'objectifSpecifique', 'name' => $this->selectedObjectifSpecifique->libelle, 'id' => $this->selectedObjectifSpecifique->id],
            ['type' => 'action', 'name' => $this->selectedAction->libelle, 'id' => $this->selectedAction->id]
        ];
        $this->selectedSousAction = null;
        $this->selectedSousActionDetails = null;

        $this->dispatch('console.log', 'DEBUG: retourListeSousActions - APR√àS r√©initialisation', [
            'currentView' => $this->currentView,
            'selectedObjectifSpecifique' => $this->selectedObjectifSpecifique ? $this->selectedObjectifSpecifique->id : 'null',
            'selectedAction' => $this->selectedAction ? $this->selectedAction->id : 'null',
            'selectedSousAction' => $this->selectedSousAction ? $this->selectedSousAction->id : 'null',
        ]);
    }

    // NOUVELLES M√âTHODES DE CR√âATION - NOMS DIFF√âRENTS
    public function openCreateOSModal()
    {
        $this->showCreateObjectifForm = true;
    }

    public function closeCreateOSModal()
    {
        $this->showCreateObjectifForm = false;
    }

    public function saveNewOS()
    {
        $this->dispatch('console.log', 'üöÄ [DEBUG] saveNewOS() appel√©e');
        
        try {
            // V√©rifier que l'utilisateur est admin g√©n√©ral
            /** @var User $user */
            $user = Auth::user();
            $this->dispatch('console.log', 'üë§ [DEBUG] Utilisateur connect√©:', $user->email);
            $this->dispatch('console.log', 'üîê [DEBUG] isAdminGeneral:', $user->isAdminGeneral());
            
            if (!$user->isAdminGeneral()) {
                $this->dispatch('console.log', '‚ùå [DEBUG] Acc√®s refus√© - Utilisateur non admin');
                $this->dispatch('showToast', ['type' => 'error', 'message' => 'Acc√®s non autoris√©. Seuls les administrateurs g√©n√©raux peuvent cr√©er des objectifs strat√©giques.']);
                return;
            }

            $this->dispatch('console.log', '‚úÖ [DEBUG] Permissions OK, validation en cours...');
            $this->dispatch('console.log', 'üìã [DEBUG] Donn√©es √† valider:', $this->newObjectifStrategique);
            
            $this->validate([
                'newObjectifStrategique.code' => 'required|string|max:50',
                'newObjectifStrategique.libelle' => 'required|string|max:255',
                'newObjectifStrategique.description' => 'nullable|string',
                'newObjectifStrategique.owner_id' => 'nullable|exists:users,id'
            ]);

            $this->dispatch('console.log', '‚úÖ [DEBUG] Validation OK, cr√©ation en cours...');
            $this->dispatch('console.log', 'üèóÔ∏è [DEBUG] Pilier ID:', $this->pilier->id);

            $objectifStrategique = new ObjectifStrategique($this->newObjectifStrategique);
            $objectifStrategique->pilier_id = $this->pilier->id;
            $objectifStrategique->save();

            $this->dispatch('console.log', '‚úÖ [DEBUG] Objectif strat√©gique cr√©√© avec succ√®s, ID:', $objectifStrategique->id);

            // Envoyer une notification √† l'utilisateur assign√© si un owner est sp√©cifi√©
            if ($this->newObjectifStrategique['owner_id']) {
                $this->dispatch('console.log', 'üìß [DEBUG] Envoi de notification √† l\'utilisateur ID:', $this->newObjectifStrategique['owner_id']);
                $owner = User::find($this->newObjectifStrategique['owner_id']);
                if ($owner) {
                    $this->dispatch('console.log', 'üë§ [DEBUG] Owner trouv√©:', $owner->email);
                    $this->dispatch('console.log', 'üìß [DEBUG] Envoi de la notification ObjectifStrategiqueAssigned...');
                    
                    $this->dispatch('console.log', 'üìß [DEBUG] Cr√©ation de la notification ObjectifStrategiqueAssigned...');
                    // Cr√©er la notification dans la table personnalis√©e
                    $notificationId = DB::table('notifications')->insertGetId([
                        'user_id' => $owner->id,
                        'type' => 'objectif_strategique_assigned',
                        'title' => 'Nouvel objectif strat√©gique assign√©',
                        'message' => "Un nouvel objectif strat√©gique vous a √©t√© assign√© : {$objectifStrategique->code} - {$objectifStrategique->libelle}",
                        'data' => json_encode([
                            'objectif_strategique_id' => $objectifStrategique->id,
                            'objectif_strategique_code' => $objectifStrategique->code,
                            'objectif_strategique_libelle' => $objectifStrategique->libelle,
                            'pilier_id' => $objectifStrategique->pilier_id,
                            'pilier_code' => $this->pilier->code,
                            'createur_id' => Auth::user()->id,
                        ]),
                        'priority' => 'normal',
                        'channel' => 'database',
                        'is_sent' => true,
                        'sent_at' => now(),
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                    
                    $this->dispatch('console.log', '‚úÖ [DEBUG] Notification personnalis√©e cr√©√©e avec ID:', $notificationId);
                    
                    Log::info('Notification personnalis√©e cr√©√©e pour l\'owner:', [
                        'notification_id' => $notificationId,
                        'owner_id' => $owner->id, 
                        'owner_email' => $owner->email,
                        'owner_name' => $owner->name,
                        'objectif_strategique_id' => $objectifStrategique->id,
                        'objectif_strategique_code' => $objectifStrategique->code,
                        'createur_id' => Auth::user()->id,
                        'createur_email' => Auth::user()->email
                    ]);
                    
                    $this->dispatch('console.log', '‚úÖ [DEBUG] Notification personnalis√©e envoy√©e √† l\'owner:', $owner->email);
                } else {
                    $this->dispatch('console.log', '‚ö†Ô∏è [DEBUG] Utilisateur owner non trouv√© avec ID:', $this->newObjectifStrategique['owner_id']);
                    Log::warning('Owner non trouv√© lors de la cr√©ation d\'objectif strat√©gique', [
                        'owner_id_demande' => $this->newObjectifStrategique['owner_id'],
                        'objectif_strategique_id' => $objectifStrategique->id
                    ]);
                }
            } else {
                $this->dispatch('console.log', '‚ÑπÔ∏è [DEBUG] Aucun owner d√©fini, pas de notification');
                Log::info('Aucun owner d√©fini pour l\'objectif strat√©gique, pas de notification envoy√©e', [
                    'objectif_strategique_id' => $objectifStrategique->id,
                    'createur_id' => Auth::user()->id
                ]);
            }

            $this->showCreateObjectifForm = false;
            $this->newObjectifStrategique = ['code' => '', 'libelle' => '', 'description' => '', 'owner_id' => ''];
            $this->loadPilierData();
            
            $this->dispatch('console.log', '‚úÖ [DEBUG] Envoi du toast de succ√®s');
            $this->dispatch('showToast', ['type' => 'success', 'message' => 'Objectif strat√©gique cr√©√© avec succ√®s']);
            
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå [DEBUG] Exception dans saveNewOS:', $e->getMessage());
            $this->dispatch('console.log', '‚ùå [DEBUG] Stack trace:', $e->getTraceAsString());
            Log::error('Erreur lors de la cr√©ation de l\'objectif strat√©gique', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la cr√©ation: ' . $e->getMessage()]);
        }
    }

    public function deleteObjectifStrategique($objectifStrategiqueId)
    {
        try {
            $objectifStrategique = ObjectifStrategique::find($objectifStrategiqueId);
            if ($objectifStrategique) {
                // V√©rifier les permissions : seul l'admin ou le owner peut supprimer
                /** @var User $user */
                $user = Auth::user();
                if (!$user->canDeleteObjectifStrategique($objectifStrategique)) {
                    $this->dispatch('showToast', ['type' => 'error', 'message' => 'Acc√®s non autoris√©. Seuls l\'administrateur g√©n√©ral et le propri√©taire de cet objectif strat√©gique peuvent le supprimer.']);
                    return;
                }

                // V√©rifier s'il y a des objectifs sp√©cifiques li√©s
                if ($objectifStrategique->objectifsSpecifiques()->count() > 0) {
                    $this->dispatch('showToast', ['type' => 'error', 'message' => 'Impossible de supprimer cet objectif strat√©gique car il contient des objectifs sp√©cifiques.']);
                    return;
                }

                $objectifStrategique->delete();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Objectif strat√©gique supprim√©']);
            }
        } catch (\Exception $e) {
            Log::error('Erreur lors de la suppression de l\'objectif strat√©gique', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la suppression']);
        }
    }
    
    public function showEditObjectifStrategiqueForm($objectifStrategiqueId)
    {
        $this->dispatch('showToast', ['type' => 'info', 'message' => 'M√©thode appel√©e avec ID: ' . $objectifStrategiqueId]);
        
        $objectifStrategique = ObjectifStrategique::find($objectifStrategiqueId);
        
        if ($objectifStrategique) {
            // V√©rifier les permissions : seul l'admin ou le owner peut √©diter
            /** @var User $user */
            $user = Auth::user();
            if (!$user->canEditObjectifStrategique($objectifStrategique)) {
                $this->dispatch('showToast', ['type' => 'error', 'message' => 'Acc√®s non autoris√©. Seuls l\'administrateur g√©n√©ral et le propri√©taire de cet objectif strat√©gique peuvent le modifier.']);
                return;
            }

            $this->editingObjectifStrategique = [
                'id' => $objectifStrategique->id,
                'code' => $objectifStrategique->code,
                'libelle' => $objectifStrategique->libelle,
                'description' => $objectifStrategique->description,
                'owner_id' => $objectifStrategique->owner_id
            ];
            $this->showEditObjectifStrategiqueForm = true;
            
            $this->dispatch('showToast', ['type' => 'success', 'message' => 'Modal d\'√©dition ouvert pour: ' . $objectifStrategique->libelle]);
        } else {
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Objectif strat√©gique non trouv√©']);
        }
    }
    
    public function showEditObjectifSpecifiqueForm($objectifSpecifiqueId)
    {
        $objectifSpecifique = ObjectifSpecifique::find($objectifSpecifiqueId);
        
        if ($objectifSpecifique) {
            $this->editingObjectifSpecifique = [
                'id' => $objectifSpecifique->id,
                'code' => $objectifSpecifique->code,
                'libelle' => $objectifSpecifique->libelle,
                'description' => $objectifSpecifique->description,
                'owner_id' => $objectifSpecifique->owner_id
            ];
            $this->showEditObjectifSpecifiqueForm = true;
        }
    }
    
    public function showEditActionForm($actionId)
    {
        $action = Action::find($actionId);
        
        if ($action) {
            $this->editingAction = [
                'id' => $action->id,
                'code' => $action->code,
                'libelle' => $action->libelle,
                'description' => $action->description,
                'owner_id' => $action->owner_id,
                'date_echeance' => $action->date_echeance,
                'date_realisation' => $action->date_realisation
            ];
            $this->showEditActionForm = true;
        }
    }
    
    public function showEditSousActionForm($sousActionId)
    {
        $sousAction = SousAction::find($sousActionId);
        
        if ($sousAction) {
            $this->editingSousAction = [
                'id' => $sousAction->id,
                'code' => $sousAction->code,
                'libelle' => $sousAction->libelle,
                'description' => $sousAction->description,
                'owner_id' => $sousAction->owner_id,
                'date_echeance' => $sousAction->date_echeance,
                'date_realisation' => $sousAction->date_realisation,
                'taux_avancement' => $sousAction->taux_avancement
            ];
            $this->showEditSousActionForm = true;
        }
    }

    // NOUVELLES M√âTHODES POUR OBJECTIFS SP√âCIFIQUES
    public function openCreateOSPModal()
    {
        $this->showCreateObjectifSpecifiqueForm = true;
    }

    public function closeCreateOSPModal()
    {
        $this->showCreateObjectifSpecifiqueForm = false;
    }

    public function saveNewOSP()
    {
        // V√©rification des permissions: Admin g√©n√©ral OU owner de l'objectif strat√©gique parent
        /** @var User $user */
        $user = Auth::user();
        if (!$user || !($user->isAdminGeneral() || ($this->selectedObjectifStrategique && $user->id === ($this->selectedObjectifStrategique->owner_id)))) {
            $this->dispatch('showToast', ['type' => 'error', 'message' => "Acc√®s non autoris√©. Seul l'admin g√©n√©ral ou l'owner de l'objectif strat√©gique peut cr√©er un objectif sp√©cifique."]);
            return;
        }

        $this->validate([
            'newObjectifSpecifique.code' => 'required|string|max:50',
            'newObjectifSpecifique.libelle' => 'required|string|max:255',
            'newObjectifSpecifique.description' => 'nullable|string',
            'newObjectifSpecifique.owner_id' => 'nullable|exists:users,id'
        ]);

        try {
            $this->dispatch('console.log', 'üöÄ [DEBUG] saveNewOSP() appel√©e');
            $objectifSpecifique = new ObjectifSpecifique($this->newObjectifSpecifique);
            $objectifSpecifique->objectif_strategique_id = $this->selectedObjectifStrategique->id;
            $objectifSpecifique->save();

            // Notification au owner de l'objectif sp√©cifique (si d√©fini)
            if (!empty($this->newObjectifSpecifique['owner_id'])) {
                $owner = User::find($this->newObjectifSpecifique['owner_id']);
                if ($owner) {
                    $notificationId = DB::table('notifications')->insertGetId([
                        'user_id' => $owner->id,
                        'type' => 'objectif_specifique_assigned',
                        'title' => 'Nouvel objectif sp√©cifique assign√©',
                        'message' => "Un nouvel objectif sp√©cifique vous a √©t√© assign√© : " . $this->selectedObjectifStrategique->code . '.' . $objectifSpecifique->code . ' - ' . $objectifSpecifique->libelle,
                        'data' => json_encode([
                            'objectif_specifique_id' => $objectifSpecifique->id,
                            'objectif_specifique_code' => $objectifSpecifique->code,
                            'objectif_specifique_libelle' => $objectifSpecifique->libelle,
                            'objectif_strategique_id' => $this->selectedObjectifStrategique->id,
                            'objectif_strategique_code' => $this->selectedObjectifStrategique->code,
                            'pilier_id' => $this->pilier->id,
                            'pilier_code' => $this->pilier->code,
                            'createur_id' => $user->id,
                        ]),
                        'priority' => 'normal',
                        'channel' => 'database',
                        'is_sent' => true,
                        'sent_at' => now(),
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                    Log::info('Notification (objectif sp√©cifique) cr√©√©e', ['notification_id' => $notificationId, 'owner_id' => $owner->id]);
                    // Rafra√Æchir le centre de notifications
                    $this->dispatch('refreshNotifications');
                    $this->dispatch('notificationReceived');
                }
            }

            $this->showCreateObjectifSpecifiqueForm = false;
            $this->newObjectifSpecifique = ['code' => '', 'libelle' => '', 'description' => '', 'owner_id' => ''];
            $this->loadPilierData();
            $this->dispatch('showToast', ['type' => 'success', 'message' => 'Objectif sp√©cifique cr√©√© avec succ√®s !']);
        } catch (\Exception $e) {
            Log::error('Erreur lors de la cr√©ation de l\'objectif sp√©cifique', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la cr√©ation']);
        }
    }
    
    public function editObjectifSpecifique($objectifSpecifiqueId)
    {
        // Debug: M√©thode d'√©dition objectif sp√©cifique
        $objectifSpecifique = ObjectifSpecifique::find($objectifSpecifiqueId);
        if ($objectifSpecifique) {
            $this->editingObjectifSpecifique = [
                'id' => $objectifSpecifique->id,
                'code' => $objectifSpecifique->code,
                'libelle' => $objectifSpecifique->libelle,
                'description' => $objectifSpecifique->description,
                'owner_id' => $objectifSpecifique->owner_id
            ];
            $this->showEditObjectifSpecifiqueForm = true;
        }
    }
    
    public function deleteObjectifSpecifique($objectifSpecifiqueId)
    {
        try {
            $objectifSpecifique = ObjectifSpecifique::find($objectifSpecifiqueId);
            if ($objectifSpecifique) {
                // V√©rifier s'il y a des actions li√©es
                if ($objectifSpecifique->actions()->count() > 0) {
                    $this->dispatch('showToast', ['type' => 'error', 'message' => 'Impossible de supprimer cet objectif sp√©cifique car il contient des actions.']);
                    return;
                }
                
                $objectifSpecifique->delete();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Objectif sp√©cifique supprim√©']);
            }
        } catch (\Exception $e) {
            Log::error('Erreur lors de la suppression de l\'objectif sp√©cifique', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la suppression']);
        }
    }

    // Gestion des actions
    public function openCreateActionModal()
    {
        $this->showCreateActionForm = true;
    }

    public function closeCreateActionModal()
    {
        $this->showCreateActionForm = false;
    }

    public function suggestNewActionCode()
    {
        $lastAction = $this->selectedObjectifSpecifique->actions()->orderBy('code', 'desc')->first();
        if ($lastAction) {
            $lastNumber = (int) substr($lastAction->code, -1);
            $this->newAction['code'] = $this->selectedObjectifSpecifique->code . '.A' . ($lastNumber + 1);
        } else {
            $this->newAction['code'] = $this->selectedObjectifSpecifique->code . '.A1';
        }
    }

    public function resetActionForm()
    {
        $this->newAction = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }
    
    public function resetSousActionForm()
    {
        $this->newSousAction = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'type' => '',
            'owner_id' => '',
            'date_echeance' => '',
            'taux_avancement' => 0
        ];
    }

    public function saveNewAction()
    {
        $this->validate([
            'newAction.code' => 'required|string|max:50',
            'newAction.libelle' => 'required|string|max:255',
            'newAction.description' => 'nullable|string',
            'newAction.owner_id' => 'nullable|exists:users,id'
        ]);

        try {
            $action = new Action($this->newAction);
            $action->objectif_specifique_id = $this->selectedObjectifSpecifique->id;
            $action->save();

            // Envoyer une notification √† l'owner de l'action
            if ($this->newAction['owner_id']) {
                /** @var \App\Models\User $owner */
                $owner = User::find($this->newAction['owner_id']);
                if ($owner) {
                    $notificationId = DB::table('notifications')->insertGetId([
                        'user_id' => $owner->id,
                        'type' => 'action_assigned',
                        'title' => 'Nouvelle action assign√©e',
                        'message' => "Une nouvelle action vous a √©t√© assign√©e : {$action->code} - {$action->libelle}",
                        'data' => json_encode([
                            'action_id' => $action->id,
                            'action_code' => $action->code,
                            'action_libelle' => $action->libelle,
                            'objectif_specifique_id' => $action->objectif_specifique_id,
                            'objectif_specifique_code' => $this->selectedObjectifSpecifique->code,
                            'objectif_strategique_id' => $this->selectedObjectifStrategique->id,
                            'objectif_strategique_code' => $this->selectedObjectifStrategique->code,
                            'pilier_id' => $this->pilier->id,
                            'pilier_code' => $this->pilier->code,
                            'createur_id' => Auth::user()->id,
                        ]),
                        'priority' => 'normal',
                        'channel' => 'database',
                        'is_sent' => true,
                        'sent_at' => now(),
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                    Log::info('Notification personnalis√©e cr√©√©e pour l\'owner de l\'action:', [
                        'notification_id' => $notificationId, 
                        'owner_id' => $owner->id, 
                        'owner_email' => $owner->email, 
                        'action_id' => $action->id, 
                        'action_code' => $action->code
                    ]);
                }
            }

            $this->showCreateActionForm = false;
            $this->newAction = ['code' => '', 'libelle' => '', 'description' => '', 'owner_id' => ''];
            $this->loadPilierData();
            
            // Rafra√Æchir le centre de notifications
            $this->dispatch('refreshNotifications');
            
            $this->dispatch('showToast', ['type' => 'success', 'message' => 'Action cr√©√©e avec succ√®s !']);
        } catch (\Exception $e) {
            Log::error('Erreur lors de la cr√©ation de l\'action', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la cr√©ation']);
        }
    }
    
    public function editAction($actionId)
    {
        // Debug: M√©thode d'√©dition action
        $action = Action::find($actionId);
        if ($action) {
            $this->editingAction = [
                'id' => $action->id,
                'code' => $action->code,
                'libelle' => $action->libelle,
                'description' => $action->description,
                'owner_id' => $action->owner_id
            ];
            $this->showEditActionForm = true;
        }
    }
    
    public function deleteAction($actionId)
    {
        try {
            $action = Action::find($actionId);
            if ($action) {
                // V√©rifier s'il y a des sous-actions li√©es
                if ($action->sousActions()->count() > 0) {
                    $this->dispatch('showToast', ['type' => 'error', 'message' => 'Impossible de supprimer cette action car elle contient des sous-actions.']);
                    return;
                }
                
                $action->delete();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Action supprim√©e']);
            }
        } catch (\Exception $e) {
            Log::error('Erreur lors de la suppression de l\'action', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la suppression']);
        }
    }

    public function saveNewSousAction()
    {
        $this->validate([
            'newSousAction.code' => 'required|string|max:50',
            'newSousAction.libelle' => 'required|string|max:255',
            'newSousAction.description' => 'nullable|string',
            'newSousAction.type' => 'required|in:normal,projet',
            'newSousAction.owner_id' => 'nullable|exists:users,id',
            'newSousAction.date_echeance' => 'nullable|date',
            'newSousAction.taux_avancement' => 'required|numeric|min:0|max:100'
        ]);

        try {
            $sousAction = new SousAction($this->newSousAction);
            $sousAction->action_id = $this->selectedAction->id;
            $sousAction->save();

            $this->showCreateSousActionForm = false;
            $this->newSousAction = [
                'code' => '', 
                'libelle' => '', 
                'description' => '', 
                'type' => '', 
                'owner_id' => '', 
                'date_echeance' => '', 
                'taux_avancement' => 0
            ];
            $this->loadPilierData();
            $this->dispatch('showToast', ['type' => 'success', 'message' => 'Sous-action cr√©√©e avec succ√®s !']);
        } catch (\Exception $e) {
            Log::error('Erreur lors de la cr√©ation de la sous-action', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la cr√©ation']);
        }
    }

    public function deleteSousAction($sousActionId)
    {
        try {
            $sousAction = SousAction::find($sousActionId);
            if ($sousAction) {
                $sousAction->delete();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Sous-action supprim√©e']);
            }
        } catch (\Exception $e) {
            Log::error('Erreur lors de la suppression de la sous-action', ['error' => $e->getMessage()]);
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la suppression']);
        }
    }






    

    


    // M√©thode de test pour v√©rifier que Livewire fonctionne
    public function testSlider()
    {
        $this->dispatch('console.log', 'DEBUG: testSlider appel√©', [
            'debugSliderValue' => $this->debugSliderValue
        ]);
        
        $this->dispatch('showToast', ['type' => 'info', 'message' => 'Test slider: ' . $this->debugSliderValue]);
    }

    // MISE √Ä JOUR SIMPLIFI√âE POUR D√âBOGAGE
    public function updateTauxSousAction($nouveauTaux, $sousActionId = null)
    {
        try {
            $this->dispatch('console.log', 'üöÄ D√âBUT - Mise √† jour simplifi√©e', [
                'nouveauTaux' => $nouveauTaux,
                'sousActionId' => $sousActionId,
                'timestamp' => now()->format('H:i:s')
            ]);

            // 1. V√âRIFICATION SIMPLE
            if (!$sousActionId) {
                $this->dispatch('console.log', '‚ùå ID de sous-action manquant');
                return;
            }

            // 2. RECHERCHE SOUS-ACTION
            $sousAction = SousAction::find($sousActionId);
            if (!$sousAction) {
                $this->dispatch('console.log', '‚ùå Sous-action non trouv√©e');
                return;
            }

            $this->dispatch('console.log', '‚úÖ Sous-action trouv√©e', [
                'id' => $sousAction->id,
                'ancienTaux' => $sousAction->taux_avancement
            ]);

            // 3. SAUVEGARDE SIMPLE
            $ancienTaux = $sousAction->taux_avancement;
            $sousAction->taux_avancement = (int)$nouveauTaux;
            $sousAction->save();

            $this->dispatch('console.log', 'üíæ Sauvegarde r√©ussie', [
                'ancien' => $ancienTaux,
                'nouveau' => $nouveauTaux
            ]);

            // 4. NOTIFICATION SIMPLE
            $this->dispatch('showToast', ['type' => 'success', 'message' => "‚úÖ Taux mis √† jour : {$ancienTaux}% ‚Üí {$nouveauTaux}%"]);
            
            $this->dispatch('console.log', 'üéâ SUCC√àS - Mise √† jour simple termin√©e');
            
        } catch (\Exception $e) {
            $this->dispatch('console.log', 'üí• ERREUR CRITIQUE', [
                'message' => $e->getMessage(),
                'fichier' => $e->getFile(),
                'ligne' => $e->getLine(),
                'trace' => $e->getTraceAsString()
            ]);
            
            $this->dispatch('showToast', ['type' => 'error', 'message' => '‚ùå Erreur: ' . $e->getMessage()]);
        }
    }

    // M√âTHODE DE TEST POUR V√âRIFIER LA CONNEXION LIVEWIRE
    public function testLivewireConnection()
    {
        $this->dispatch('console.log', 'üß™ Test Livewire - Connexion OK', [
            'timestamp' => now()->format('H:i:s'),
            'currentView' => $this->currentView,
            'pilierId' => $this->pilierId
        ]);
        
        $this->dispatch('showToast', ['type' => 'success', 'message' => 'üß™ Test Livewire - Connexion OK !']);
    }

    // M√âTHODE DE TEST SP√âCIFIQUE POUR LE BOUTON 75%
    public function testButton75($sousActionId)
    {
        $this->dispatch('console.log', 'üß™ Test bouton 75% - M√©thode appel√©e', [
            'sousActionId' => $sousActionId,
            'timestamp' => now()->format('H:i:s')
        ]);
        
        $this->dispatch('showToast', ['type' => 'info', 'message' => "üß™ Test bouton 75% - ID: {$sousActionId}"]);
    }

    // M√âTHODE DE TEST AVEC M√äMES PARAM√àTRES QUE updateSousActionTauxSimple
    public function testUpdateMethod($nouveauTaux, $sousActionId)
    {
        $this->dispatch('console.log', 'üß™ Test updateSousActionTauxSimple - M√©thode appel√©e', [
            'nouveauTaux' => $nouveauTaux,
            'sousActionId' => $sousActionId,
            'timestamp' => now()->format('H:i:s')
        ]);
        
        $this->dispatch('showToast', ['type' => 'success', 'message' => "üß™ Test r√©ussi - {$nouveauTaux}% pour sous-action {$sousActionId}"]);
    }

    // M√âTHODE DE TEST TR√àS SIMPLE
    public function testSimple()
    {
        $this->dispatch('console.log', 'üß™ Test simple - M√©thode appel√©e');
        $this->dispatch('showToast', ['type' => 'info', 'message' => 'üß™ Test simple OK !']);
    }

    public function updateParentRates($sousAction)
    {
        $this->dispatch('console.log', 'üîÑ updateParentRates - D√âBUT', [
            'sousActionId' => $sousAction->id,
            'sousActionTaux' => $sousAction->taux_avancement,
            'timestamp' => now()->format('H:i:s')
        ]);

        try {
        // Mettre √† jour le taux de l'action
        $action = $sousAction->action;
        if ($action) {
                $ancienTauxAction = $action->taux_avancement;
            $sousActions = $action->sousActions;
            if ($sousActions->count() > 0) {
                    $nouveauTauxAction = round($sousActions->avg('taux_avancement'), 1);
                    $action->taux_avancement = $nouveauTauxAction;
                $action->save();
                    
                    $this->dispatch('console.log', 'DEBUG: updateParentRates - Action mise √† jour', [
                        'actionId' => $action->id,
                        'ancienTaux' => $ancienTauxAction,
                        'nouveauTaux' => $nouveauTauxAction
                    ]);
                
                // Mettre √† jour le taux de l'objectif sp√©cifique
                $objectifSpecifique = $action->objectifSpecifique;
                if ($objectifSpecifique) {
                        $ancienTauxOS = $objectifSpecifique->taux_avancement;
                    $actions = $objectifSpecifique->actions;
                    if ($actions->count() > 0) {
                            $nouveauTauxOS = round($actions->avg('taux_avancement'), 1);
                            $objectifSpecifique->taux_avancement = $nouveauTauxOS;
                        $objectifSpecifique->save();
                            
                            $this->dispatch('console.log', 'DEBUG: updateParentRates - Objectif Sp√©cifique mis √† jour', [
                                'objectifSpecifiqueId' => $objectifSpecifique->id,
                                'ancienTaux' => $ancienTauxOS,
                                'nouveauTaux' => $nouveauTauxOS
                            ]);
                        
                        // Mettre √† jour le taux de l'objectif strat√©gique
                        $objectifStrategique = $objectifSpecifique->objectifStrategique;
                        if ($objectifStrategique) {
                                $ancienTauxOS = $objectifStrategique->taux_avancement;
                            $objectifsSpecifiques = $objectifStrategique->objectifsSpecifiques;
                            if ($objectifsSpecifiques->count() > 0) {
                                    $nouveauTauxOS = round($objectifsSpecifiques->avg('taux_avancement'), 1);
                                    $objectifStrategique->taux_avancement = $nouveauTauxOS;
                                $objectifStrategique->save();
                                    
                                    $this->dispatch('console.log', 'DEBUG: updateParentRates - Objectif Strat√©gique mis √† jour', [
                                        'objectifStrategiqueId' => $objectifStrategique->id,
                                        'ancienTaux' => $ancienTauxOS,
                                        'nouveauTaux' => $nouveauTauxOS
                                    ]);
                                
                                // Mettre √† jour le taux du pilier
                                $pilier = $objectifStrategique->pilier;
                                if ($pilier) {
                                        $ancienTauxPilier = $pilier->taux_avancement;
                                    $objectifsStrategiques = $pilier->objectifsStrategiques;
                                    if ($objectifsStrategiques->count() > 0) {
                                            $nouveauTauxPilier = round($objectifsStrategiques->avg('taux_avancement'), 1);
                                            $pilier->taux_avancement = $nouveauTauxPilier;
                                        $pilier->save();
                                            
                                            $this->dispatch('console.log', 'DEBUG: updateParentRates - Pilier mis √† jour', [
                                                'pilierId' => $pilier->id,
                                                'ancienTaux' => $ancienTauxPilier,
                                                'nouveauTaux' => $nouveauTauxPilier
                                            ]);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            }
            
            $this->dispatch('console.log', 'DEBUG: updateParentRates - SUCC√àS', [
                'message' => 'Tous les taux parents ont √©t√© mis √† jour avec succ√®s'
            ]);
            
        } catch (\Exception $e) {
            Log::error('Erreur lors de la mise √† jour des taux parents', ['error' => $e->getMessage()]);
            $this->dispatch('console.log', 'DEBUG: updateParentRates - ERREUR', [
                'error' => $e->getMessage()
            ]);
            throw $e;
        }
    }

    // ===== NOUVELLES M√âTHODES DE CALCUL EN CASCADE =====

    /**
     * Calcule le taux d'une action = MOYENNE des taux des sous-actions
     */
    public function calculerTauxAction($actionId)
    {
        try {
            $action = Action::with('sousActions')->find($actionId);
            if (!$action || $action->sousActions->count() == 0) {
                return 0;
            }

            $tauxTotal = $action->sousActions->sum('taux_avancement');
            $nombreSousActions = $action->sousActions->count();
            $tauxMoyen = round($tauxTotal / $nombreSousActions, 1);

            $this->dispatch('console.log', 'üìä Calcul taux Action', [
                'actionId' => $actionId,
                'sousActions' => $nombreSousActions,
                'tauxTotal' => $tauxTotal,
                'tauxMoyen' => $tauxMoyen
            ]);

            return $tauxMoyen;

        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur calcul taux Action', ['error' => $e->getMessage()]);
            return 0;
        }
    }

    /**
     * Calcule le taux d'un objectif sp√©cifique = MOYENNE des taux des actions
     */
    public function calculerTauxObjectifSpecifique($objectifSpecifiqueId)
    {
        try {
            $objectifSpecifique = ObjectifSpecifique::with('actions')->find($objectifSpecifiqueId);
            if (!$objectifSpecifique || $objectifSpecifique->actions->count() == 0) {
                return 0;
            }

            $tauxTotal = $objectifSpecifique->actions->sum('taux_avancement');
            $nombreActions = $objectifSpecifique->actions->count();
            $tauxMoyen = round($tauxTotal / $nombreActions, 1);

            $this->dispatch('console.log', 'üìä Calcul taux Objectif Sp√©cifique', [
                'osId' => $objectifSpecifiqueId,
                'actions' => $nombreActions,
                'tauxTotal' => $tauxTotal,
                'tauxMoyen' => $tauxMoyen
            ]);

            return $tauxMoyen;

        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur calcul taux Objectif Sp√©cifique', ['error' => $e->getMessage()]);
            return 0;
        }
    }

    /**
     * Calcule le taux d'un objectif strat√©gique = MOYENNE des taux des objectifs sp√©cifiques
     */
    public function calculerTauxObjectifStrategique($objectifStrategiqueId)
    {
        try {
            $objectifStrategique = ObjectifStrategique::with('objectifsSpecifiques')->find($objectifStrategiqueId);
            if (!$objectifStrategique || $objectifStrategique->objectifsSpecifiques->count() == 0) {
                return 0;
            }

            $tauxTotal = $objectifStrategique->objectifsSpecifiques->sum('taux_avancement');
            $nombreOS = $objectifStrategique->objectifsSpecifiques->count();
            $tauxMoyen = round($tauxTotal / $nombreOS, 1);

            $this->dispatch('console.log', 'üìä Calcul taux Objectif Strat√©gique', [
                'ostId' => $objectifStrategiqueId,
                'objectifsSpecifiques' => $nombreOS,
                'tauxTotal' => $tauxTotal,
                'tauxMoyen' => $tauxMoyen
            ]);

            return $tauxMoyen;

        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur calcul taux Objectif Strat√©gique', ['error' => $e->getMessage()]);
            return 0;
        }
    }

    /**
     * Calcule le taux d'un pilier = MOYENNE des taux des objectifs strat√©giques
     */
    public function calculerTauxPilier($pilierId)
    {
        try {
            $pilier = Pilier::with('objectifsStrategiques')->find($pilierId);
            if (!$pilier || $pilier->objectifsStrategiques->count() == 0) {
                return 0;
            }

            $tauxTotal = $pilier->objectifsStrategiques->sum('taux_avancement');
            $nombreOST = $pilier->objectifsStrategiques->count();
            $tauxMoyen = round($tauxTotal / $nombreOST, 1);

            $this->dispatch('console.log', 'üìä Calcul taux Pilier', [
                'pilierId' => $pilierId,
                'objectifsStrategiques' => $nombreOST,
                'tauxTotal' => $tauxTotal,
                'tauxMoyen' => $tauxMoyen
            ]);

            return $tauxMoyen;

        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur calcul taux Pilier', ['error' => $e->getMessage()]);
            return 0;
        }
    }

    // Propri√©t√©s calcul√©es
    public function getUsersProperty()
    {
        try {
            return User::whereHas('role', function($query) {
                $query->whereIn('nom', ['admin_general', 'owner_pil', 'owner_action']);
            })->get();
        } catch (\Exception $e) {
            // Fallback : retourner tous les users si la relation √©choue
            Log::warning('Erreur lors du chargement des users avec r√¥les, fallback vers tous les users', ['error' => $e->getMessage()]);
            return User::all();
        }
    }

    public function getProgressStatus($taux)
    {
        if ($taux >= 100) return 'success';
        if ($taux >= 75) return 'info';
        if ($taux >= 50) return 'warning';
        return 'danger';
    }

    public function calculateEcart($dateEcheance, $dateRealisation)
    {
        if (!$dateEcheance) return null;
        
        $echeance = Carbon::parse($dateEcheance);
        $realisation = $dateRealisation ? Carbon::parse($dateRealisation) : Carbon::now();
        
        $diff = $echeance->diffInDays($realisation, false);
        
        if ($diff < 0) {
            return abs($diff) . 'J en avance';
        } elseif ($diff > 0) {
            return $diff . 'J de retard';
        } else {
            return '√Ä jour';
        }
    }

    // M√©thodes pour les formulaires de cr√©ation
    public function resetCreateForm()
    {
        $this->newObjectifStrategique = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }
    
    public function resetObjectifSpecifiqueForm()
    {
        $this->newObjectifSpecifique = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }
    
    public function hideCreateObjectifForm()
    {
        $this->showCreateObjectifForm = false;
        $this->resetCreateForm();
    }
    
    public function hideCreateObjectifSpecifiqueForm()
    {
        $this->showCreateObjectifSpecifiqueForm = false;
        $this->resetObjectifSpecifiqueForm();
    }
    
    public function hideCreateActionForm()
    {
        $this->showCreateActionForm = false;
        $this->resetActionForm();
    }
    
    public function hideCreateSousActionForm()
    {
        $this->showCreateSousActionForm = false;
        $this->resetSousActionForm();
    }
    
    // M√©thodes pour les formulaires d'√©dition
    public function hideEditObjectifForm()
    {
        $this->showEditObjectifStrategiqueForm = false;
        $this->editingObjectifStrategique = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }
    
    public function hideEditObjectifSpecifiqueForm()
    {
        $this->showEditObjectifSpecifiqueForm = false;
        $this->editingObjectifSpecifique = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }
    
    public function hideEditActionForm()
    {
        $this->showEditActionForm = false;
        $this->editingAction = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'owner_id' => ''
        ];
    }
    
    public function hideEditSousActionForm()
    {
        $this->showEditSousActionForm = false;
        $this->editingSousAction = [
            'code' => '',
            'libelle' => '',
            'description' => '',
            'type' => '',
            'owner_id' => '',
            'date_echeance' => '',
            'date_realisation' => '',
            'taux_avancement' => 0
        ];
    }
    
    // M√©thodes de mise √† jour
    public function updateObjectifStrategique()
    {
        $this->dispatch('console.log', 'üöÄ [DEBUG] updateObjectifStrategique() appel√©e');
        
        try {
            $this->dispatch('console.log', 'üìã [DEBUG] Donn√©es d\'√©dition:', $this->editingObjectifStrategique);
            
            $this->validate([
                'editingObjectifStrategique.code' => 'required|string|max:10',
                'editingObjectifStrategique.libelle' => 'required|string|max:255',
                'editingObjectifStrategique.description' => 'nullable|string',
                'editingObjectifStrategique.owner_id' => 'nullable|exists:users,id',
            ]);

            $this->dispatch('console.log', '‚úÖ [DEBUG] Validation OK, recherche de l\'objectif...');

            $objectifStrategique = ObjectifStrategique::find($this->editingObjectifStrategique['id'] ?? null);
            if ($objectifStrategique) {
                $this->dispatch('console.log', '‚úÖ [DEBUG] Objectif strat√©gique trouv√©, mise √† jour en cours...');
                
                $objectifStrategique->update([
                    'code' => $this->editingObjectifStrategique['code'],
                    'libelle' => $this->editingObjectifStrategique['libelle'],
                    'description' => $this->editingObjectifStrategique['description'],
                    'owner_id' => $this->editingObjectifStrategique['owner_id'] ?: null,
                ]);
                
                $this->dispatch('console.log', '‚úÖ [DEBUG] Objectif strat√©gique mis √† jour avec succ√®s');
                
                $this->hideEditObjectifForm();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Objectif strat√©gique mis √† jour avec succ√®s !']);
            } else {
                $this->dispatch('console.log', '‚ùå [DEBUG] Objectif strat√©gique non trouv√© avec ID:', $this->editingObjectifStrategique['id'] ?? 'null');
                $this->dispatch('showToast', ['type' => 'error', 'message' => 'Objectif strat√©gique non trouv√©']);
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå [DEBUG] Exception dans updateObjectifStrategique:', $e->getMessage());
            $this->dispatch('console.log', '‚ùå [DEBUG] Stack trace:', $e->getTraceAsString());
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la mise √† jour: ' . $e->getMessage()]);
        }
    }
    
    public function updateObjectifSpecifique()
    {
        $this->dispatch('console.log', 'üöÄ updateObjectifSpecifique appel√©e');
        
        $this->validate([
            'editingObjectifSpecifique.code' => 'required|string|max:10',
            'editingObjectifSpecifique.libelle' => 'required|string|max:255',
            'editingObjectifSpecifique.description' => 'nullable|string',
            'editingObjectifSpecifique.owner_id' => 'nullable|exists:users,id',
        ]);

        try {
            $objectifSpecifique = ObjectifSpecifique::find($this->editingObjectifSpecifique['id'] ?? null);
            if ($objectifSpecifique) {
                $objectifSpecifique->update([
                    'code' => $this->editingObjectifSpecifique['code'],
                    'libelle' => $this->editingObjectifSpecifique['libelle'],
                    'description' => $this->editingObjectifSpecifique['description'],
                    'owner_id' => $this->editingObjectifSpecifique['owner_id'] ?: null,
                ]);
                
                $this->dispatch('console.log', '‚úÖ Objectif sp√©cifique mis √† jour avec succ√®s');
                $this->hideEditObjectifSpecifiqueForm();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Objectif sp√©cifique mis √† jour avec succ√®s !']);
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur updateObjectifSpecifique: ' . $e->getMessage());
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la mise √† jour']);
        }
    }
    
    public function updateAction()
    {
        $this->dispatch('console.log', 'üöÄ updateAction appel√©e');
        
        $this->validate([
            'editingAction.code' => 'required|string|max:10',
            'editingAction.libelle' => 'required|string|max:255',
            'editingAction.description' => 'nullable|string',
            'editingAction.owner_id' => 'nullable|exists:users,id',
        ]);

        try {
            $action = Action::find($this->editingAction['id'] ?? null);
            if ($action) {
                $action->update([
                    'code' => $this->editingAction['code'],
                    'libelle' => $this->editingAction['libelle'],
                    'description' => $this->editingAction['description'],
                    'owner_id' => $this->editingAction['owner_id'] ?: null,
                ]);
                
                $this->dispatch('console.log', '‚úÖ Action mise √† jour avec succ√®s');
                $this->hideEditActionForm();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Action mise √† jour avec succ√®s !']);
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur updateAction: ' . $e->getMessage());
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la mise √† jour']);
        }
    }
    
    public function updateSousAction()
    {
        $this->dispatch('console.log', 'üöÄ updateSousAction appel√©e');
        
        $this->validate([
            'editingSousAction.code' => 'required|string|max:10',
            'editingSousAction.libelle' => 'required|string|max:255',
            'editingSousAction.description' => 'nullable|string',
            'editingSousAction.type' => 'required|in:normal,projet',
            'editingSousAction.owner_id' => 'nullable|exists:users,id',
            'editingSousAction.date_echeance' => 'nullable|date',
            'editingSousAction.taux_avancement' => 'required|numeric|min:0|max:100'
        ]);

        try {
            $sousAction = SousAction::find($this->editingSousAction['id'] ?? null);
            if ($sousAction) {
                $updateData = [
                    'code' => $this->editingSousAction['code'],
                    'libelle' => $this->editingSousAction['libelle'],
                    'description' => $this->editingSousAction['description'],
                    'type' => $this->editingSousAction['type'],
                    'owner_id' => $this->editingSousAction['owner_id'] ?: null,
                    'date_echeance' => $this->editingSousAction['date_echeance'] ?: null,
                ];
                
                // Gestion sp√©ciale pour les actions normales
                if ($this->editingSousAction['type'] === 'normal') {
                    $updateData['taux_avancement'] = $this->editingSousAction['taux_avancement'];
                    
                    // Si le taux est 100%, d√©finir la date de r√©alisation
                    if ($this->editingSousAction['taux_avancement'] == 100) {
                        $updateData['date_realisation'] = now();
                    }
                }
                // Pour les projets, le taux reste inchang√© (calcul√© automatiquement)
                
                $sousAction->update($updateData);
                
                $this->dispatch('console.log', '‚úÖ Sous-action mise √† jour avec succ√®s');
                $this->hideEditSousActionForm();
                $this->loadPilierData();
                $this->dispatch('showToast', ['type' => 'success', 'message' => 'Sous-action mise √† jour avec succ√®s !']);
            }
        } catch (\Exception $e) {
            $this->dispatch('console.log', '‚ùå Erreur updateSousAction: ' . $e->getMessage());
            $this->dispatch('showToast', ['type' => 'error', 'message' => 'Erreur lors de la mise √† jour']);
        }
    }
    
    // M√âTHODES MANQUANTES POUR LA CR√âATION ET L'√âDITION
    
    // === CR√âATION OBJECTIF STRAT√âGIQUE ===
    public function showCreateObjectifForm()
    {
        $this->dispatch('console.log', 'üöÄ showCreateObjectifForm appel√©e');
        $this->showCreateObjectifForm = true;
        $this->resetFormData();
    }
    
    // === CR√âATION OBJECTIF SP√âCIFIQUE ===
    public function showCreateObjectifSpecifiqueForm()
    {
        $this->dispatch('console.log', 'üöÄ showCreateObjectifSpecifiqueForm appel√©e');
        $this->showCreateObjectifSpecifiqueForm = true;
        $this->resetFormData();
    }
    
    // === CR√âATION ACTION ===
    public function showCreateActionForm()
    {
        $this->dispatch('console.log', 'üöÄ showCreateActionForm appel√©e');
        $this->showCreateActionForm = true;
        $this->resetFormData();
    }
    
    // === √âDITION OBJECTIF STRAT√âGIQUE ===
    public function showEditObjectifForm()
    {
        $this->dispatch('console.log', 'üöÄ showEditObjectifForm appel√©e');
        $this->showEditObjectifStrategiqueForm = true;
    }
    
    // === M√âTHODES DE CR√âATION MANQUANTES ===
    
    public function createObjectifStrategique()
    {
        $this->dispatch('console.log', 'üöÄ createObjectifStrategique appel√©e');
        return $this->saveNewOS();
    }
    
    public function createObjectifSpecifique()
    {
        $this->dispatch('console.log', 'üöÄ createObjectifSpecifique appel√©e');
        return $this->saveNewOSP();
    }
    
    public function createAction()
    {
        $this->dispatch('console.log', 'üöÄ createAction appel√©e');
        return $this->saveNewAction();
    }
    
    // === CR√âATION SOUS-ACTION ===
    public function openModalCreateSousAction()
    {
        $this->dispatch('console.log', 'üöÄ openModalCreateSousAction appel√©e');
        $this->showCreateSousActionForm = true;
        $this->dispatch('console.log', '‚úÖ Modal de cr√©ation de sous-action ouvert');
    }
    
    public function closeModalCreateSousAction()
    {
        $this->dispatch('console.log', 'üöÄ closeModalCreateSousAction appel√©e');
        $this->showCreateSousActionForm = false;
        $this->dispatch('console.log', '‚úÖ Modal de cr√©ation de sous-action ferm√©');
    }


    public function render()
    {
        return view('livewire.pilier-hierarchique-modal');
    }


} 
